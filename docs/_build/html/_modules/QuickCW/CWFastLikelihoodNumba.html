<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QuickCW.CWFastLikelihoodNumba &mdash; QuickCW  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            QuickCW
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">QuickCW</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">QuickCW.CWFastLikelihoodNumba</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for QuickCW.CWFastLikelihoodNumba</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;C 2021 Matthew Digman and Bence Becsy</span>
<span class="sd">numba version of fast likelihood&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numba</span> <span class="k">as</span> <span class="nn">nb</span>
<span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">njit</span><span class="p">,</span><span class="n">prange</span>
<span class="kn">from</span> <span class="nn">numba.experimental</span> <span class="kn">import</span> <span class="n">jitclass</span>
<span class="kn">from</span> <span class="nn">numba.typed</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">import</span> <span class="nn">scipy.linalg</span>

<span class="kn">from</span> <span class="nn">enterprise</span> <span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">const</span>
<span class="kn">from</span> <span class="nn">QuickCW.lapack_wrappers</span> <span class="kn">import</span> <span class="n">solve_triangular</span>

<span class="kn">import</span> <span class="nn">QuickCW.const_mcmc</span> <span class="k">as</span> <span class="nn">cm</span>

<div class="viewcode-block" id="FastLikeMaster"><a class="viewcode-back" href="../../QuickCW.html#QuickCW.CWFastLikelihoodNumba.FastLikeMaster">[docs]</a><span class="k">class</span> <span class="nc">FastLikeMaster</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;class to store pta things so they do not have to be recomputed when red noise is recomputed&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">psrs</span><span class="p">,</span><span class="n">pta</span><span class="p">,</span><span class="n">params</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">includeCW</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">prior_recovery</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get Class for generating the fast CW likelihood.</span>
<span class="sd">        </span>
<span class="sd">        :param pta:</span>
<span class="sd">        `enterprise` pta object.</span>
<span class="sd">        :param params:</span>
<span class="sd">        Dictionary of noise parameters.</span>
<span class="sd">        :param x0:</span>
<span class="sd">        CWInfo object, which is partially redundant with params but better handled by numba</span>
<span class="sd">        :param includeCW:</span>
<span class="sd">        Switch if we want to include the contribution of the CW signal or not [True]</span>
<span class="sd">        :param prior_recovery:</span>
<span class="sd">        If True, we return constant likelihood to be used for prior recovery diagnostic test [False]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Npsr</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">Npsr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pta</span> <span class="o">=</span> <span class="n">pta</span>

        <span class="c1">#include switch to easily turn off CW for TD Bayes factor calculation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">includeCW</span> <span class="o">=</span> <span class="n">includeCW</span>

        <span class="c1">#include switch to get constant log_likelihoods for prior recovery tests</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prior_recovery</span> <span class="o">=</span> <span class="n">prior_recovery</span>

        <span class="c1">#put the positions into an array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Npsr</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Npsr</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">psr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">psrs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">psr</span><span class="o">.</span><span class="n">pos</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pdist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">psr</span><span class="o">.</span><span class="n">pdist</span>

        <span class="c1">#get the N vects without putting them in a matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nvecs</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pta</span><span class="o">.</span><span class="n">get_ndiag</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>


        <span class="c1">#get the part of the determinant that can be computed right now</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logdet</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pta</span><span class="o">.</span><span class="n">get_rNr_logdet</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logdet</span> <span class="o">+=</span> <span class="n">m</span>
        <span class="c1">#self.logdet += np.sum([m for (l,m) in self.pta.get_rNr_logdet(self.params)])</span>

        <span class="c1">#get the other pta results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TNTs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pta</span><span class="o">.</span><span class="n">get_TNT</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="n">Ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pta</span><span class="o">.</span><span class="n">get_basis</span><span class="p">()</span>

        <span class="c1">#invchol_Sigma_Ts = List()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nrs</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isqrNvecs</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
        <span class="c1">#unify types outside numba to avoid slowing down compilation</span>
        <span class="c1">#also add more components to logdet</span>

        <span class="c1">#put toas and residuals into a numba typed List of arrays, which shouldn&#39;t require any actual copies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toas</span> <span class="o">=</span> <span class="n">List</span><span class="p">([</span><span class="n">psr</span><span class="o">.</span><span class="n">toas</span> <span class="k">for</span> <span class="n">psr</span> <span class="ow">in</span> <span class="n">psrs</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residuals</span> <span class="o">=</span> <span class="n">List</span><span class="p">([</span><span class="n">psr</span><span class="o">.</span><span class="n">residuals</span> <span class="k">for</span> <span class="n">psr</span> <span class="ow">in</span> <span class="n">psrs</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">resres_rNr</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TNvs</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dotTNrs</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Npsr</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isqrNvecs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nvecs</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Nrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residuals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nvecs</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resres_rNr</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nrs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nrs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">TNvs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">Ts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nvecs</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="c1">#store F contiguous version</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dotTNrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nrs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">TNvs</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

        <span class="c1">#put the rnr part of resres onto logdet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logdet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resres_rNr</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">logdet</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_toa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toas</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Npsr</span><span class="p">):</span>
            <span class="c1">#find the latest arriving signal to prohibit signals that have already merged</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_toa</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_toa</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toas</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

<div class="viewcode-block" id="FastLikeMaster.get_new_FastLike"><a class="viewcode-back" href="../../QuickCW.html#QuickCW.CWFastLikelihoodNumba.FastLikeMaster.get_new_FastLike">[docs]</a>    <span class="k">def</span> <span class="nf">get_new_FastLike</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">params</span><span class="p">):</span>
        <span class="n">chol_Sigmas</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
        <span class="n">phiinvs</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Npsr</span><span class="p">):</span>
            <span class="n">chol_Sigmas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">TNvs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="c1">#temporary but can&#39;t be 0 or else the initialization of FLI will crash</span>
            <span class="n">phiinvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TNvs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="n">FLI</span> <span class="o">=</span> <span class="n">FastLikeInfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logdet</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pdist</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">toas</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Nvecs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Nrs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">max_toa</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">Npsr</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">isqrNvecs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">TNvs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dotTNrs</span><span class="p">,</span><span class="n">chol_Sigmas</span><span class="p">,</span><span class="n">phiinvs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">includeCW</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">prior_recovery</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">recompute_FastLike</span><span class="p">(</span><span class="n">FLI</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">params</span><span class="p">)</span></div>
    <span class="c1">#@profile</span>
<div class="viewcode-block" id="FastLikeMaster.recompute_FastLike"><a class="viewcode-back" href="../../QuickCW.html#QuickCW.CWFastLikelihoodNumba.FastLikeMaster.recompute_FastLike">[docs]</a>    <span class="k">def</span> <span class="nf">recompute_FastLike</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">FLI</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">params</span><span class="p">,</span> <span class="n">chol_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#mask to skip updating values if set to True</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Npsr</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">FLI</span><span class="o">.</span><span class="n">prior_recovery</span><span class="p">:</span>
            <span class="n">pls_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pta</span><span class="o">.</span><span class="n">get_phiinv</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">logdet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;partition&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">chol_update</span><span class="p">:</span> <span class="c1">#update Cholesky of Sigma instead of recompute</span>
                <span class="c1">#chol_Sigmas, logdet_array, new_phiinvs = cholupdate_loop(FLI.chol_Sigmas, List(pls_temp), FLI.phiinvs, self.Npsr)</span>
                <span class="c1">#</span>
                <span class="c1">#FLI.chol_Sigmas = chol_Sigmas</span>
                <span class="c1">#FLI.logdet_array = logdet_array</span>
                <span class="c1">#FLI.phiinvs = new_phiinvs</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Npsr</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                        <span class="k">continue</span>

                    <span class="n">phiinv_loc</span><span class="p">,</span><span class="n">logdetphi_loc</span> <span class="o">=</span> <span class="n">pls_temp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">chol_Sigma</span> <span class="o">=</span> <span class="n">cholupdate</span><span class="p">(</span><span class="n">FLI</span><span class="o">.</span><span class="n">chol_Sigmas</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">phiinv_loc</span><span class="o">-</span><span class="n">FLI</span><span class="o">.</span><span class="n">phiinvs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

                    <span class="n">logdet_Sigma_loc</span> <span class="o">=</span> <span class="n">logdet_Sigma_helper</span><span class="p">(</span><span class="n">chol_Sigma</span><span class="p">)</span>

                    <span class="n">FLI</span><span class="o">.</span><span class="n">chol_Sigmas</span><span class="p">[</span><span class="n">i</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">chol_Sigma</span>

                    <span class="n">FLI</span><span class="o">.</span><span class="n">logdet_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">logdetphi_loc</span><span class="o">+</span><span class="n">logdet_Sigma_loc</span>

                    <span class="n">FLI</span><span class="o">.</span><span class="n">phiinvs</span><span class="p">[</span><span class="n">i</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">phiinv_loc</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Npsr</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                        <span class="k">continue</span>

                    <span class="n">phiinv_loc</span><span class="p">,</span><span class="n">logdetphi_loc</span> <span class="o">=</span> <span class="n">pls_temp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                    <span class="n">FLI</span><span class="o">.</span><span class="n">phiinvs</span><span class="p">[</span><span class="n">i</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">phiinv_loc</span>
                    <span class="k">if</span> <span class="n">phiinv_loc</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1">#Sigma_alt = self.TNTs[i]+np.diag(phiinv_loc)</span>
                        <span class="c1">#overwrite old chol_Sigma so can be done without allocating new array</span>
                        <span class="n">Sigma</span> <span class="o">=</span> <span class="n">create_Sigma</span><span class="p">(</span><span class="n">phiinv_loc</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">TNTs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">FLI</span><span class="o">.</span><span class="n">chol_Sigmas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                        <span class="c1">#assert np.allclose(Sigma,Sigma_alt)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">Sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TNTs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">phiinv_loc</span>

                    <span class="c1">#mutate inplace to avoid memory allocation overheads</span>
                    <span class="n">chol_Sigma</span><span class="p">,</span><span class="n">lower</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cho_factor</span><span class="p">(</span><span class="n">Sigma</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">lower</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">overwrite_a</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">check_finite</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                    <span class="n">logdet_Sigma_loc</span> <span class="o">=</span> <span class="n">logdet_Sigma_helper</span><span class="p">(</span><span class="n">chol_Sigma</span><span class="p">)</span><span class="c1">#2 * np.sum(np.log(np.diag(chol_Sigma)))</span>

                    <span class="c1">#this should be mutated in place but assign it anyway to be safe</span>
                    <span class="n">FLI</span><span class="o">.</span><span class="n">chol_Sigmas</span><span class="p">[</span><span class="n">i</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">chol_Sigma</span>

                    <span class="c1">#add the necessary component to logdet</span>
                    <span class="n">FLI</span><span class="o">.</span><span class="n">logdet_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">logdetphi_loc</span><span class="o">+</span><span class="n">logdet_Sigma_loc</span>


            <span class="c1">#set logdet</span>
            <span class="n">FLI</span><span class="o">.</span><span class="n">set_resres_logdet</span><span class="p">(</span><span class="n">FLI</span><span class="o">.</span><span class="n">resres_array</span><span class="p">,</span><span class="n">FLI</span><span class="o">.</span><span class="n">logdet_array</span><span class="p">,</span><span class="n">FLI</span><span class="o">.</span><span class="n">logdet_base</span><span class="p">)</span>

        <span class="c1">#list of pulsars updated</span>
        <span class="n">psr_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="n">FLI</span><span class="o">.</span><span class="n">update_red_noise</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">psr_idxs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">FLI</span><span class="c1">#FastLikeInfo(resres,logdet,self.pos,self.pdist,self.toas,invchol_Sigma_TNs,self.Nvecs,self.Nrs,self.max_toa,x0,self.Npsr,self.isqrNvecs,self.residuals)</span></div></div>

<div class="viewcode-block" id="cholupdate_loop"><a class="viewcode-back" href="../../QuickCW.html#QuickCW.CWFastLikelihoodNumba.cholupdate_loop">[docs]</a><span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">cholupdate_loop</span><span class="p">(</span><span class="n">chol_Sigmas</span><span class="p">,</span> <span class="n">pls_temp</span><span class="p">,</span> <span class="n">old_phiinvs</span><span class="p">,</span> <span class="n">Npsr</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Jitted loop over Sigma matrices to update their Cholesky.</span>
<span class="sd">    Currently not faster than recalculating from scratch, so not used.</span>

<span class="sd">    :param chol_Sigmas:</span>
<span class="sd">    List of Cholesky decompositions of Sigma matrices</span>
<span class="sd">    :param pls_temp:</span>
<span class="sd">    New list of tuples returned by pta.get_phiinv</span>
<span class="sd">    :param old_phiinvs:</span>
<span class="sd">    Old list of phiinv matrices</span>
<span class="sd">    :param Npsr:</span>
<span class="sd">    Number of pulsars (also number of Sigma matrices)</span>

<span class="sd">    :return chol_Sigmas:</span>
<span class="sd">    List of updated Choleskies</span>
<span class="sd">    :return logdet_array:</span>
<span class="sd">    New array containing logdet values</span>
<span class="sd">    :return new_phiinvs:</span>
<span class="sd">    List of new phiinv matrices</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logdet_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Npsr</span><span class="p">)</span>
    <span class="n">new_phiinvs</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Npsr</span><span class="p">):</span>
        <span class="n">phiinv_loc</span><span class="p">,</span><span class="n">logdetphi_loc</span> <span class="o">=</span> <span class="n">pls_temp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">chol_Sigmas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cholupdate</span><span class="p">(</span><span class="n">chol_Sigmas</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">phiinv_loc</span><span class="o">-</span><span class="n">old_phiinvs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">new_phiinvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phiinv_loc</span><span class="p">)</span>
        <span class="n">logdet_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">logdet_Sigma_helper</span><span class="p">(</span><span class="n">chol_Sigmas</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="n">logdetphi_loc</span>

    <span class="k">return</span> <span class="n">chol_Sigmas</span><span class="p">,</span> <span class="n">logdet_array</span><span class="p">,</span> <span class="n">new_phiinvs</span></div>

<div class="viewcode-block" id="cholupdate"><a class="viewcode-back" href="../../QuickCW.html#QuickCW.CWFastLikelihoodNumba.cholupdate">[docs]</a><span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">cholupdate</span><span class="p">(</span><span class="n">L_in</span><span class="p">,</span><span class="n">diag_diff</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Jitted routine to update the Cholesky of a matrix instead of recomputing it.</span>
<span class="sd">    In principle could be faster, but right now it is not, so it&#39;s not used.</span>

<span class="sd">    :param L_in:</span>
<span class="sd">    Previous Cholesky that we want to update</span>
<span class="sd">    :param diag_diff:</span>
<span class="sd">    Differences in the diagonal of the original matrix</span>

<span class="sd">    :return L:</span>
<span class="sd">    Updated Cholesky    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">L_in</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1">#L = L_in</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">L_in</span><span class="p">)</span>
    <span class="c1">#for idx, diff in enumerate(diag_diff):</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">diag_diff</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">diff</span><span class="o">!=</span><span class="mf">0.0</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">diff</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">x</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
                <span class="n">sign</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="k">elif</span> <span class="n">diff</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">x</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="o">-</span><span class="n">diff</span><span class="p">)</span>
                <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
            <span class="c1">#print(x)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
                <span class="c1">#print(L[k,k]**2)</span>
                <span class="c1">#print(x[k]**2)</span>
                <span class="c1">#print(L[k,k]**2 + sign * x[k]**2)</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">L</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">r</span> <span class="o">/</span> <span class="n">L</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">/</span> <span class="n">L</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
                <span class="n">L</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
                <span class="c1">#L[k+1:n,k] = (L[k+1:n,k] + sign * s*x[k+1:n]) / c</span>
                <span class="c1">#x[k+1:n] = c * x[k+1:n] - s * L[k+1:n,k]</span>
                <span class="c1">#for j in prange(k+1,n): #1 ms (~30% of runtime) this loop</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">):</span> <span class="c1">#1 ms (~30% of runtime) this loop</span>
                    <span class="n">L</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">L</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">sign</span><span class="o">*</span> <span class="n">s</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">/</span> <span class="n">c</span>
                    <span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">s</span> <span class="o">*</span> <span class="n">L</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">L</span></div>


<div class="viewcode-block" id="logdet_Sigma_helper"><a class="viewcode-back" href="../../QuickCW.html#QuickCW.CWFastLikelihoodNumba.logdet_Sigma_helper">[docs]</a><span class="nd">@njit</span><span class="p">(</span><span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">logdet_Sigma_helper</span><span class="p">(</span><span class="n">chol_Sigma</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;get logdet sigma from cholesky of Sigma</span>

<span class="sd">    :param chol_Sigma:</span>
<span class="sd">    Cholesky decomposition of Sigma matrix</span>

<span class="sd">    :return 2*res:</span>
<span class="sd">    Contribution to logdet from this Sigma matrix</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">for</span> <span class="n">itrj</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">chol_Sigma</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">chol_Sigma</span><span class="p">[</span><span class="n">itrj</span><span class="p">,</span><span class="n">itrj</span><span class="p">])</span>
    <span class="k">return</span> <span class="mi">2</span><span class="o">*</span><span class="n">res</span></div>


<div class="viewcode-block" id="create_Sigma"><a class="viewcode-back" href="../../QuickCW.html#QuickCW.CWFastLikelihoodNumba.create_Sigma">[docs]</a><span class="nd">@njit</span><span class="p">(</span><span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">create_Sigma</span><span class="p">(</span><span class="n">phiinv_loc</span><span class="p">,</span><span class="n">TNT</span><span class="p">,</span><span class="n">Sigma</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;create just the upper triangle of the Sigma matrix with phiinv_loc added to the diagonal, lower triangle will be garbage</span>

<span class="sd">    :param phiinv_loc:</span>
<span class="sd">    phiinv matrix</span>
<span class="sd">    :param TNT:</span>
<span class="sd">    Precomputed matrix product of TNT</span>
<span class="sd">    :param Sigma:</span>
<span class="sd">    Initialized mtrix with the right shape to hold Sigma</span>
<span class="sd">    (allows for just overwriting instead of creating new array each time we update this)</span>

<span class="sd">    :return Sigma:</span>
<span class="sd">    Upper trinagle Sigma matrix - lower triangle is junk</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#Sigma = np.zeros((phiinv_loc.size,phiinv_loc.size))</span>
    <span class="k">for</span> <span class="n">itrj1</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">phiinv_loc</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
        <span class="n">Sigma</span><span class="p">[</span><span class="n">itrj1</span><span class="p">,</span><span class="n">itrj1</span><span class="p">]</span> <span class="o">=</span> <span class="n">TNT</span><span class="p">[</span><span class="n">itrj1</span><span class="p">,</span><span class="n">itrj1</span><span class="p">]</span><span class="o">+</span><span class="n">phiinv_loc</span><span class="p">[</span><span class="n">itrj1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">itrj2</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">itrj1</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">phiinv_loc</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="n">Sigma</span><span class="p">[</span><span class="n">itrj1</span><span class="p">,</span><span class="n">itrj2</span><span class="p">]</span> <span class="o">=</span> <span class="n">TNT</span><span class="p">[</span><span class="n">itrj1</span><span class="p">,</span><span class="n">itrj2</span><span class="p">]</span>
    <span class="c1">#for itrj1 in prange(0,phiinv_loc.size):</span>
    <span class="k">return</span> <span class="n">Sigma</span></div>

<div class="viewcode-block" id="CWInfo"><a class="viewcode-back" href="../../QuickCW.html#QuickCW.CWFastLikelihoodNumba.CWInfo">[docs]</a><span class="nd">@jitclass</span><span class="p">([(</span><span class="s1">&#39;Npsr&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>\
           <span class="p">(</span><span class="s1">&#39;cw_p_dists&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:]),(</span><span class="s1">&#39;cw_p_phases&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:]),(</span><span class="s1">&#39;rn_gammas&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:]),(</span><span class="s1">&#39;rn_log10_As&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:]),</span>\
           <span class="p">(</span><span class="s1">&#39;cos_gwtheta&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),(</span><span class="s1">&#39;cos_inc&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),(</span><span class="s1">&#39;gwphi&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),(</span><span class="s1">&#39;log10_fgw&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),(</span><span class="s1">&#39;log10_h&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>\
           <span class="p">(</span><span class="s1">&#39;log10_mc&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),(</span><span class="s1">&#39;phase0&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),(</span><span class="s1">&#39;psi&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),(</span><span class="s1">&#39;gwb_gamma&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),(</span><span class="s1">&#39;gwb_log10_A&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>\
           <span class="p">(</span><span class="s1">&#39;idx_dists&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">[:]),(</span><span class="s1">&#39;idx_phases&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">[:]),(</span><span class="s1">&#39;idx_rn_gammas&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">[:]),(</span><span class="s1">&#39;idx_rn_log10_As&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">[:]),</span>\
           <span class="p">(</span><span class="s1">&#39;idx_cos_gwtheta&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">),(</span><span class="s1">&#39;idx_cos_inc&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">),(</span><span class="s1">&#39;idx_gwphi&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">),(</span><span class="s1">&#39;idx_log10_fgw&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">),(</span><span class="s1">&#39;idx_log10_h&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>\
           <span class="p">(</span><span class="s1">&#39;idx_log10_mc&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">),(</span><span class="s1">&#39;idx_phase0&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">),(</span><span class="s1">&#39;idx_psi&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">),(</span><span class="s1">&#39;idx_gwb_gamma&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">),(</span><span class="s1">&#39;idx_gwb_log10_A&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>\
           <span class="p">(</span><span class="s1">&#39;idx_rn&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">[:]),(</span><span class="s1">&#39;idx_gwb&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">[:]),(</span><span class="s1">&#39;idx_int&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">[:]),(</span><span class="s1">&#39;idx_cw_ext&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">[:]),(</span><span class="s1">&#39;idx_cw_int&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">[:])])</span>
<span class="k">class</span> <span class="nc">CWInfo</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;simple jitclass to store the various parmeters in a way that can be accessed quickly from a numba environment</span>

<span class="sd">    :param Npsr:</span>
<span class="sd">    Number of pulsars</span>
<span class="sd">    :param params_in:</span>
<span class="sd">    Array of all parameters in the same order as in par_names</span>
<span class="sd">    :param par_names:</span>
<span class="sd">    List of parameter names - must follow certain naming conventions so we can identify parameters</span>
<span class="sd">    :param par_names_cw_ext:</span>
<span class="sd">    Subset of all parameters that describe the CW signal and are projection parameters (previously called extrinsic parameters)</span>
<span class="sd">    :param par_names_cw_int:</span>
<span class="sd">    Subset of all parameters that describe the CW signal and are shape parameters (previously called intrinsic parameters)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">Npsr</span><span class="p">,</span><span class="n">params_in</span><span class="p">,</span><span class="n">par_names</span><span class="p">,</span><span class="n">par_names_cw_ext</span><span class="p">,</span><span class="n">par_names_cw_int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Npsr</span> <span class="o">=</span> <span class="n">Npsr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx_phases</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">par_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">par</span><span class="p">)</span> <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">par_names</span> <span class="k">if</span> <span class="s2">&quot;_cw0_p_phase&quot;</span> <span class="ow">in</span> <span class="n">par</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx_dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">par_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">par</span><span class="p">)</span> <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">par_names</span> <span class="k">if</span> <span class="s2">&quot;_cw0_p_dist&quot;</span> <span class="ow">in</span> <span class="n">par</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">idx_rn_gammas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">par_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">par</span><span class="p">)</span> <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">par_names</span> <span class="k">if</span> <span class="s2">&quot;_red_noise_gamma&quot;</span> <span class="ow">in</span> <span class="n">par</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx_rn_log10_As</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">par_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">par</span><span class="p">)</span> <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">par_names</span> <span class="k">if</span> <span class="s2">&quot;_red_noise_log10_A&quot;</span> <span class="ow">in</span> <span class="n">par</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx_rn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_rn_gammas</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_rn_log10_As</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">idx_gwb_gamma</span> <span class="o">=</span> <span class="n">par_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;gwb_gamma&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx_gwb_log10_A</span> <span class="o">=</span> <span class="n">par_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;gwb_log10_A&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx_gwb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_gwb_gamma</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx_gwb_log10_A</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">idx_cos_inc</span> <span class="o">=</span> <span class="n">par_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;0_cos_inc&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx_log10_h</span> <span class="o">=</span> <span class="n">par_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;0_log10_h&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx_phase0</span> <span class="o">=</span> <span class="n">par_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;0_phase0&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx_psi</span> <span class="o">=</span> <span class="n">par_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;0_psi&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">idx_cos_gwtheta</span> <span class="o">=</span> <span class="n">par_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;0_cos_gwtheta&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx_gwphi</span> <span class="o">=</span> <span class="n">par_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;0_gwphi&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx_log10_fgw</span> <span class="o">=</span> <span class="n">par_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;0_log10_fgw&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx_log10_mc</span> <span class="o">=</span> <span class="n">par_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;0_log10_mc&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">idx_cw_ext</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">par_names_cw_ext</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">name_ext</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">par_names_cw_ext</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">idx_cw_ext</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">par_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name_ext</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">idx_cw_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">par_names_cw_int</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">name_int</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">par_names_cw_int</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">idx_cw_int</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">par_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name_int</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">idx_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_rn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx_gwb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx_cw_int</span><span class="p">))</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">update_params</span><span class="p">(</span><span class="n">params_in</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">params_in</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cw_p_phases</span> <span class="o">=</span> <span class="n">params_in</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_phases</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cw_p_dists</span> <span class="o">=</span> <span class="n">params_in</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_dists</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cos_inc</span> <span class="o">=</span> <span class="n">params_in</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_cos_inc</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log10_h</span> <span class="o">=</span> <span class="n">params_in</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_log10_h</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase0</span> <span class="o">=</span> <span class="n">params_in</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_phase0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psi</span> <span class="o">=</span> <span class="n">params_in</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_psi</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cos_gwtheta</span> <span class="o">=</span> <span class="n">params_in</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_cos_gwtheta</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gwphi</span> <span class="o">=</span> <span class="n">params_in</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_gwphi</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log10_fgw</span> <span class="o">=</span> <span class="n">params_in</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_log10_fgw</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log10_mc</span> <span class="o">=</span> <span class="n">params_in</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_log10_mc</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rn_gammas</span> <span class="o">=</span> <span class="n">params_in</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_rn_gammas</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rn_log10_As</span> <span class="o">=</span> <span class="n">params_in</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_rn_log10_As</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gwb_gamma</span> <span class="o">=</span> <span class="n">params_in</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_gwb_gamma</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gwb_log10_A</span> <span class="o">=</span> <span class="n">params_in</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_gwb_log10_A</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">validate_consistent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">params_in</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;check current params match input params&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">isclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cw_p_phases</span><span class="p">,</span><span class="n">params_in</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_phases</span><span class="p">]))</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">isclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cw_p_dists</span><span class="p">,</span> <span class="n">params_in</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_dists</span><span class="p">]))</span>
        <span class="k">assert</span> <span class="n">isclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cos_inc</span><span class="p">,</span> <span class="n">params_in</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_cos_inc</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">isclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log10_h</span><span class="p">,</span> <span class="n">params_in</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_log10_h</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">isclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase0</span><span class="p">,</span> <span class="n">params_in</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_phase0</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">isclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="p">,</span> <span class="n">params_in</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_psi</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">isclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cos_gwtheta</span><span class="p">,</span> <span class="n">params_in</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_cos_gwtheta</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">isclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gwphi</span><span class="p">,</span> <span class="n">params_in</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_gwphi</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">isclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log10_fgw</span><span class="p">,</span> <span class="n">params_in</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_log10_fgw</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">isclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log10_mc</span><span class="p">,</span> <span class="n">params_in</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_log10_mc</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">isclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rn_gammas</span><span class="p">,</span> <span class="n">params_in</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_rn_gammas</span><span class="p">]))</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">isclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rn_log10_As</span><span class="p">,</span> <span class="n">params_in</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_rn_log10_As</span><span class="p">]))</span>
        <span class="k">assert</span> <span class="n">isclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gwb_gamma</span><span class="p">,</span> <span class="n">params_in</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_gwb_gamma</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">isclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gwb_log10_A</span><span class="p">,</span> <span class="n">params_in</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_gwb_log10_A</span><span class="p">])</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="get_lnlikelihood_helper"><a class="viewcode-back" href="../../QuickCW.html#QuickCW.CWFastLikelihoodNumba.get_lnlikelihood_helper">[docs]</a><span class="nd">@njit</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">get_lnlikelihood_helper</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">resres</span><span class="p">,</span><span class="n">logdet</span><span class="p">,</span><span class="n">pos</span><span class="p">,</span><span class="n">pdist</span><span class="p">,</span><span class="n">NN</span><span class="p">,</span><span class="n">MMs</span><span class="p">,</span><span class="n">includeCW</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">prior_recovery</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;jittable helper for calculating the log likelihood in CWFastLikelihood</span>
<span class="sd">    </span>
<span class="sd">    :param x0:</span>
<span class="sd">    CWInfo object</span>
<span class="sd">    :param resres:</span>
<span class="sd">    Array holding the (residual|residual) inner product</span>
<span class="sd">    :param logdet:</span>
<span class="sd">    Log determinant piece of the likelihood</span>
<span class="sd">    :param pos:</span>
<span class="sd">    (number of pulsars, 3) array holding 3d unit vector pointing towards each pulsar given by psr.pos</span>
<span class="sd">    :param pdist:</span>
<span class="sd">    (number of pulsars, 2) array holding distance and error of distance for each pulsar in kpc given by psr.pdist</span>
<span class="sd">    :param NN:</span>
<span class="sd">    N matrices holding (filter|residual) type inner products</span>
<span class="sd">    :param MMs:</span>
<span class="sd">    M matrices holding (filter|filter) type inner products</span>
<span class="sd">    :param includeCW:</span>
<span class="sd">    Switch if we want to include the contribution of the CW signal or not [True]</span>
<span class="sd">    :param prior_recovery:</span>
<span class="sd">    If True, we return constant likelihood to be used for prior recovery diagnostic test [False]</span>

<span class="sd">    :return log_L:</span>
<span class="sd">    Log likelihood value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">prior_recovery</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fgw</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="n">x0</span><span class="o">.</span><span class="n">log10_fgw</span>
        <span class="n">amp</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="n">x0</span><span class="o">.</span><span class="n">log10_h</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">fgw</span><span class="p">)</span>
        <span class="n">mc</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="n">x0</span><span class="o">.</span><span class="n">log10_mc</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">Tsun</span>


        <span class="n">sin_gwtheta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">x0</span><span class="o">.</span><span class="n">cos_gwtheta</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">sin_gwphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x0</span><span class="o">.</span><span class="n">gwphi</span><span class="p">)</span>
        <span class="n">cos_gwphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x0</span><span class="o">.</span><span class="n">gwphi</span><span class="p">)</span>

        <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sin_gwphi</span><span class="p">,</span> <span class="o">-</span><span class="n">cos_gwphi</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">x0</span><span class="o">.</span><span class="n">cos_gwtheta</span> <span class="o">*</span> <span class="n">cos_gwphi</span><span class="p">,</span> <span class="o">-</span><span class="n">x0</span><span class="o">.</span><span class="n">cos_gwtheta</span> <span class="o">*</span> <span class="n">sin_gwphi</span><span class="p">,</span> <span class="n">sin_gwtheta</span><span class="p">])</span>
        <span class="n">omhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">sin_gwtheta</span> <span class="o">*</span> <span class="n">cos_gwphi</span><span class="p">,</span> <span class="o">-</span><span class="n">sin_gwtheta</span> <span class="o">*</span> <span class="n">sin_gwphi</span><span class="p">,</span> <span class="o">-</span><span class="n">x0</span><span class="o">.</span><span class="n">cos_gwtheta</span><span class="p">])</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

        <span class="n">cos_phase0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x0</span><span class="o">.</span><span class="n">phase0</span><span class="p">)</span>
        <span class="n">sin_phase0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x0</span><span class="o">.</span><span class="n">phase0</span><span class="p">)</span>
        <span class="n">sin_2psi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">x0</span><span class="o">.</span><span class="n">psi</span><span class="p">)</span>
        <span class="n">cos_2psi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">x0</span><span class="o">.</span><span class="n">psi</span><span class="p">)</span>

        <span class="n">log_L</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">resres</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">logdet</span>

        <span class="k">if</span> <span class="n">includeCW</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">x0</span><span class="o">.</span><span class="n">Npsr</span><span class="p">):</span>
                <span class="n">m_pos</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="n">n_pos</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="n">cosMu</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
                    <span class="n">m_pos</span> <span class="o">+=</span> <span class="n">m</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">n_pos</span> <span class="o">+=</span> <span class="n">n</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">cosMu</span> <span class="o">-=</span> <span class="n">omhat</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="c1">#m_pos = np.dot(m, pos[i])</span>
                <span class="c1">#n_pos = np.dot(n, pos[i])</span>
                <span class="c1">#cosMu = -np.dot(omhat, pos[i])</span>

                <span class="n">F_p</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">m_pos</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">n_pos</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cosMu</span><span class="p">)</span>
                <span class="n">F_c</span> <span class="o">=</span> <span class="p">(</span><span class="n">m_pos</span> <span class="o">*</span> <span class="n">n_pos</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cosMu</span><span class="p">)</span>

                <span class="n">p_dist</span> <span class="o">=</span> <span class="p">(</span><span class="n">pdist</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">pdist</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">x0</span><span class="o">.</span><span class="n">cw_p_dists</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">kpc</span><span class="o">/</span><span class="n">const</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>

                <span class="n">w0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">fgw</span>
                <span class="n">omega_p0</span> <span class="o">=</span> <span class="n">w0</span> <span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">256</span><span class="o">/</span><span class="mi">5</span> <span class="o">*</span> <span class="n">mc</span><span class="o">**</span><span class="p">(</span><span class="mi">5</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">w0</span><span class="o">**</span><span class="p">(</span><span class="mi">8</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">p_dist</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">cosMu</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span>

                <span class="n">amp_psr</span> <span class="o">=</span> <span class="n">amp</span> <span class="o">*</span> <span class="p">(</span><span class="n">w0</span><span class="o">/</span><span class="n">omega_p0</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span>
                <span class="n">phase0_psr</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">cw_p_phases</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="n">cos_phase0_psr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x0</span><span class="o">.</span><span class="n">phase0</span><span class="o">+</span><span class="n">phase0_psr</span><span class="o">*</span><span class="mf">2.0</span><span class="p">)</span>
                <span class="n">sin_phase0_psr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x0</span><span class="o">.</span><span class="n">phase0</span><span class="o">+</span><span class="n">phase0_psr</span><span class="o">*</span><span class="mf">2.0</span><span class="p">)</span>

                <span class="n">sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">amp</span><span class="o">*</span><span class="p">(</span>   <span class="n">cos_phase0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">x0</span><span class="o">.</span><span class="n">cos_inc</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">cos_2psi</span> <span class="o">*</span> <span class="n">F_p</span> <span class="o">+</span> <span class="n">sin_2psi</span> <span class="o">*</span> <span class="n">F_c</span><span class="p">)</span> <span class="o">+</span>    <span class="c1">#Earth term sine</span>
                                  <span class="mi">2</span><span class="o">*</span><span class="n">sin_phase0</span> <span class="o">*</span>     <span class="n">x0</span><span class="o">.</span><span class="n">cos_inc</span>    <span class="o">*</span> <span class="p">(</span><span class="o">+</span><span class="n">sin_2psi</span> <span class="o">*</span> <span class="n">F_p</span> <span class="o">+</span> <span class="n">cos_2psi</span> <span class="o">*</span> <span class="n">F_c</span><span class="p">)</span>   <span class="p">)</span>
                <span class="n">sigma</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">amp</span><span class="o">*</span><span class="p">(</span>   <span class="n">sin_phase0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">x0</span><span class="o">.</span><span class="n">cos_inc</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">cos_2psi</span> <span class="o">*</span> <span class="n">F_p</span> <span class="o">+</span> <span class="n">sin_2psi</span> <span class="o">*</span> <span class="n">F_c</span><span class="p">)</span> <span class="o">+</span>    <span class="c1">#Earth term cosine</span>
                                  <span class="mi">2</span><span class="o">*</span><span class="n">cos_phase0</span> <span class="o">*</span>     <span class="n">x0</span><span class="o">.</span><span class="n">cos_inc</span>    <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">sin_2psi</span> <span class="o">*</span> <span class="n">F_p</span> <span class="o">-</span> <span class="n">cos_2psi</span> <span class="o">*</span> <span class="n">F_c</span><span class="p">)</span>   <span class="p">)</span>
                <span class="n">sigma</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="o">-</span><span class="n">amp_psr</span><span class="o">*</span><span class="p">(</span>   <span class="n">cos_phase0_psr</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">x0</span><span class="o">.</span><span class="n">cos_inc</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">cos_2psi</span> <span class="o">*</span> <span class="n">F_p</span> <span class="o">+</span> <span class="n">sin_2psi</span> <span class="o">*</span> <span class="n">F_c</span><span class="p">)</span> <span class="o">+</span>    <span class="c1">#Pulsar term sine</span>
                                  <span class="mi">2</span><span class="o">*</span><span class="n">sin_phase0_psr</span> <span class="o">*</span>     <span class="n">x0</span><span class="o">.</span><span class="n">cos_inc</span>    <span class="o">*</span> <span class="p">(</span><span class="o">+</span><span class="n">sin_2psi</span> <span class="o">*</span> <span class="n">F_p</span> <span class="o">+</span> <span class="n">cos_2psi</span> <span class="o">*</span> <span class="n">F_c</span><span class="p">)</span>   <span class="p">)</span>
                <span class="n">sigma</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>  <span class="o">-</span><span class="n">amp_psr</span><span class="o">*</span><span class="p">(</span>   <span class="n">sin_phase0_psr</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">x0</span><span class="o">.</span><span class="n">cos_inc</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">cos_2psi</span> <span class="o">*</span> <span class="n">F_p</span> <span class="o">+</span> <span class="n">sin_2psi</span> <span class="o">*</span> <span class="n">F_c</span><span class="p">)</span> <span class="o">+</span>    <span class="c1">#Pulsar term cosine</span>
                                  <span class="mi">2</span><span class="o">*</span><span class="n">cos_phase0_psr</span> <span class="o">*</span>     <span class="n">x0</span><span class="o">.</span><span class="n">cos_inc</span>    <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">sin_2psi</span> <span class="o">*</span> <span class="n">F_p</span> <span class="o">-</span> <span class="n">cos_2psi</span> <span class="o">*</span> <span class="n">F_c</span><span class="p">)</span>   <span class="p">)</span>

                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
                    <span class="n">log_L</span> <span class="o">+=</span> <span class="n">sigma</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">NN</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

                <span class="n">prodMMPart</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
                        <span class="n">prodMMPart</span> <span class="o">+=</span> <span class="n">sigma</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">MMs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">sigma</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

                <span class="n">log_L</span> <span class="o">-=</span> <span class="n">prodMMPart</span><span class="o">/</span><span class="mi">2</span><span class="c1">#np.dot(sigma,np.dot(MMs[i],sigma))/2</span>

        <span class="k">return</span> <span class="n">log_L</span></div>

<div class="viewcode-block" id="update_intrinsic_params2"><a class="viewcode-back" href="../../QuickCW.html#QuickCW.CWFastLikelihoodNumba.update_intrinsic_params2">[docs]</a><span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">update_intrinsic_params2</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">isqrNvecs</span><span class="p">,</span><span class="n">Nrs</span><span class="p">,</span><span class="n">pos</span><span class="p">,</span><span class="n">pdist</span><span class="p">,</span><span class="n">toas</span><span class="p">,</span><span class="n">NN</span><span class="p">,</span><span class="n">MMs</span><span class="p">,</span><span class="n">TNvs</span><span class="p">,</span><span class="n">chol_Sigmas</span><span class="p">,</span><span class="n">idxs</span><span class="p">,</span><span class="n">resres_array</span><span class="p">,</span><span class="n">dotTNrs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Calculate inner products N=(res|S), M=(S|S)</span>

<span class="sd">    :param x0:</span>
<span class="sd">    CWInfo object</span>
<span class="sd">    :param isqrNvecs:</span>
<span class="sd">    Inverse squareroot of N vectors</span>
<span class="sd">    :param Nrs:</span>
<span class="sd">    Residuals times inverse sqareroot N vectors</span>
<span class="sd">    :param pos:</span>
<span class="sd">    (number of pulsars, 3) array holding 3d unit vector pointing towards each pulsar given by psr.pos</span>
<span class="sd">    :param pdist:</span>
<span class="sd">    (number of pulsars, 2) array holding distance and error of distance for each pulsar in kpc given by psr.pdist</span>
<span class="sd">    :param toas:</span>
<span class="sd">    List of arrays of TOAs for each pulsar</span>
<span class="sd">    :param NN:</span>
<span class="sd">    N matrices holding (filter|residual) type inner products</span>
<span class="sd">    :param MMs:</span>
<span class="sd">    M matrices holding (filter|filter) type inner products</span>
<span class="sd">    :param TNvs:</span>
<span class="sd">    T vectros times inverse squareroot N vectors</span>
<span class="sd">    :param chol_Sigmas:</span>
<span class="sd">    List of Cholesky decompositions of Sigma matrices</span>
<span class="sd">    :param idxs:</span>
<span class="sd">    Indices of pulsar for which we want to update things</span>
<span class="sd">    :param resres_array:</span>
<span class="sd">    Array containing contributions to (res|res)</span>
<span class="sd">    :param dotTNrs:</span>
<span class="sd">    Precalculated dot product of Nrs and TNvs</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">w0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mf">10.0</span><span class="o">**</span><span class="n">x0</span><span class="o">.</span><span class="n">log10_fgw</span>
    <span class="n">mc</span> <span class="o">=</span> <span class="mf">10.0</span><span class="o">**</span><span class="n">x0</span><span class="o">.</span><span class="n">log10_mc</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">Tsun</span>
    <span class="n">gwtheta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">x0</span><span class="o">.</span><span class="n">cos_gwtheta</span><span class="p">)</span>

    <span class="n">sin_gwtheta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gwtheta</span><span class="p">)</span>
    <span class="n">cos_gwtheta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gwtheta</span><span class="p">)</span>
    <span class="n">sin_gwphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x0</span><span class="o">.</span><span class="n">gwphi</span><span class="p">)</span>
    <span class="n">cos_gwphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x0</span><span class="o">.</span><span class="n">gwphi</span><span class="p">)</span>

    <span class="n">omhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">sin_gwtheta</span> <span class="o">*</span> <span class="n">cos_gwphi</span><span class="p">,</span> <span class="o">-</span><span class="n">sin_gwtheta</span> <span class="o">*</span> <span class="n">sin_gwphi</span><span class="p">,</span> <span class="o">-</span><span class="n">cos_gwtheta</span><span class="p">])</span>



    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
        <span class="n">MM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

        <span class="n">cosMu</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">omhat</span><span class="p">,</span> <span class="n">pos</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>

        <span class="n">p_dist</span> <span class="o">=</span> <span class="p">(</span><span class="n">pdist</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">pdist</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">x0</span><span class="o">.</span><span class="n">cw_p_dists</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">kpc</span><span class="o">/</span><span class="n">const</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>

        <span class="n">omega_p013</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mf">1.</span> <span class="o">+</span> <span class="mf">256.</span><span class="o">/</span><span class="mf">5.</span> <span class="o">*</span> <span class="n">mc</span><span class="o">**</span><span class="p">(</span><span class="mi">5</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">w0</span><span class="o">**</span><span class="p">(</span><span class="mi">8</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">p_dist</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">cosMu</span><span class="p">)))))</span>

        <span class="c1">#get the solution to Lx=a for N, note this uses my own numba compatible lapack wrapper but is basically the same as scipy</span>
        <span class="c1">#invCholSigmaTN = invchol_Sigma_TNs[ii]</span>
        <span class="c1">#SigmaTNrProd = SigmaTNrProds[ii]</span>

        <span class="c1">#divide the signals by N</span>
        <span class="n">Nr</span> <span class="o">=</span> <span class="n">Nrs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="c1">#residuals[ii]/Nvecs[ii]</span>
        <span class="n">isqrNvec</span> <span class="o">=</span> <span class="n">isqrNvecs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">toas_in</span> <span class="o">=</span> <span class="n">toas</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">TNv</span> <span class="o">=</span> <span class="n">TNvs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">chol_Sigma</span> <span class="o">=</span> <span class="n">chol_Sigmas</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">dotTNr</span> <span class="o">=</span> <span class="n">dotTNrs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="c1">#resres_array[ii] = 0.</span>
        <span class="n">n1</span><span class="p">,</span><span class="n">n2</span> <span class="o">=</span> <span class="n">TNv</span><span class="o">.</span><span class="n">shape</span>

        <span class="n">esNr</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">ecNr</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">psNr</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">pcNr</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="n">esNes</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">ecNec</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">psNps</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">pcNpc</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="n">ecNes</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">psNes</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">pcNes</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">psNec</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">pcNec</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">pcNps</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="c1">#get the sin and cosine parts</span>
        <span class="n">ET_sin</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n1</span><span class="p">)</span>
        <span class="n">ET_cos</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n1</span><span class="p">)</span>

        <span class="n">PT_sin</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n1</span><span class="p">)</span>
        <span class="n">PT_cos</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n1</span><span class="p">)</span>

        <span class="c1">#break out this loop instead of using numpy syntax so we don&#39;t have to store omegas and phases ever</span>
        <span class="k">for</span> <span class="n">itrk</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">n1</span><span class="p">):</span>
            <span class="c1">#set up filters</span>
            <span class="n">toas_loc</span> <span class="o">=</span> <span class="n">toas_in</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span> <span class="o">-</span> <span class="n">cm</span><span class="o">.</span><span class="n">tref</span>
            <span class="c1">#NOTE factored out the common w0 into factor of w0**(-5/3) in phase, cancels in ratios</span>
            <span class="c1">#also replace omega with 1/omega**(1/3), which is the quantity we actually need</span>
            <span class="c1">#if sqrt is a native cpu function 3 sqrts will probably be faster than taking the eigth root</span>
            <span class="n">omega13</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mf">1.</span> <span class="o">-</span> <span class="mf">256.</span><span class="o">/</span><span class="mf">5.</span> <span class="o">*</span> <span class="n">mc</span><span class="o">**</span><span class="p">(</span><span class="mf">5.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span> <span class="o">*</span> <span class="n">w0</span><span class="o">**</span><span class="p">(</span><span class="mf">8.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span> <span class="o">*</span> <span class="n">toas_loc</span><span class="p">))))</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">32</span><span class="o">/</span><span class="n">mc</span><span class="o">**</span><span class="p">(</span><span class="mi">5</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">w0</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">omega13</span><span class="o">**</span><span class="mi">5</span><span class="p">)</span>

            <span class="n">tp</span> <span class="o">=</span> <span class="n">toas_loc</span> <span class="o">-</span> <span class="n">p_dist</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">cosMu</span><span class="p">)</span>
            <span class="n">omega_p13</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mf">1.</span><span class="o">/</span><span class="n">omega_p013</span><span class="o">**</span><span class="mi">8</span> <span class="o">-</span> <span class="mf">256.</span><span class="o">/</span><span class="mf">5.</span> <span class="o">*</span> <span class="n">mc</span><span class="o">**</span><span class="p">(</span><span class="mi">5</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">w0</span><span class="o">**</span><span class="p">(</span><span class="mi">8</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="n">omega_p013</span><span class="o">**</span><span class="mi">8</span> <span class="o">*</span> <span class="n">tp</span><span class="p">))))</span>

            <span class="n">phase_p</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">32</span><span class="o">*</span><span class="n">mc</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">w0</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">omega_p013</span><span class="o">**</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">omega_p13</span><span class="o">**</span><span class="mi">5</span><span class="p">)</span>

            <span class="n">PT_amp</span> <span class="o">=</span> <span class="n">isqrNvec</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span> <span class="o">*</span> <span class="n">omega_p13</span>
            <span class="n">ET_amp</span> <span class="o">=</span> <span class="n">isqrNvec</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span> <span class="o">*</span> <span class="n">omega13</span>

            <span class="n">PT_sin</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span> <span class="o">=</span> <span class="n">PT_amp</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">phase_p</span><span class="p">)</span>
            <span class="n">PT_cos</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span> <span class="o">=</span> <span class="n">PT_amp</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">phase_p</span><span class="p">)</span>


            <span class="n">ET_sin</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span> <span class="o">=</span> <span class="n">ET_amp</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">phase</span><span class="p">)</span>
            <span class="n">ET_cos</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span> <span class="o">=</span> <span class="n">ET_amp</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">phase</span><span class="p">)</span>

            <span class="c1">#get the results</span>


            <span class="n">psNps</span> <span class="o">+=</span> <span class="n">PT_sin</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span><span class="o">*</span><span class="n">PT_sin</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span>
            <span class="n">pcNpc</span> <span class="o">+=</span> <span class="n">PT_cos</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span><span class="o">*</span><span class="n">PT_cos</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span>

            <span class="n">psNes</span> <span class="o">+=</span> <span class="n">PT_sin</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span><span class="o">*</span><span class="n">ET_sin</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span>
            <span class="n">pcNes</span> <span class="o">+=</span> <span class="n">PT_cos</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span><span class="o">*</span><span class="n">ET_sin</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span>
            <span class="n">psNec</span> <span class="o">+=</span> <span class="n">PT_sin</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span><span class="o">*</span><span class="n">ET_cos</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span>
            <span class="n">pcNec</span> <span class="o">+=</span> <span class="n">PT_cos</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span><span class="o">*</span><span class="n">ET_cos</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span>
            <span class="n">pcNps</span> <span class="o">+=</span> <span class="n">PT_cos</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span><span class="o">*</span><span class="n">PT_sin</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span>

            <span class="c1">#these segments aren&#39;t the time limiting factor so we don&#39;t see any real speedup from skipping them</span>
            <span class="c1">#if not dist_only:</span>
            <span class="c1">#Nes = iNvec[itrk]*ET_sin[itrk]</span>
            <span class="c1">#Nec = iNvec[itrk]*ET_cos[itrk]</span>
            <span class="n">esNes</span> <span class="o">+=</span> <span class="n">ET_sin</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span><span class="o">*</span><span class="n">ET_sin</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span>
            <span class="n">ecNec</span> <span class="o">+=</span> <span class="n">ET_cos</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span><span class="o">*</span><span class="n">ET_cos</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span>
            <span class="n">ecNes</span> <span class="o">+=</span> <span class="n">ET_cos</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span><span class="o">*</span><span class="n">ET_sin</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span>

            <span class="n">psNr</span> <span class="o">+=</span> <span class="n">Nr</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span><span class="o">*</span><span class="n">PT_sin</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span>
            <span class="n">pcNr</span> <span class="o">+=</span> <span class="n">Nr</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span><span class="o">*</span><span class="n">PT_cos</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span>
            <span class="n">esNr</span> <span class="o">+=</span> <span class="n">Nr</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span><span class="o">*</span><span class="n">ET_sin</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span>
            <span class="n">ecNr</span> <span class="o">+=</span> <span class="n">Nr</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span><span class="o">*</span><span class="n">ET_cos</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span>

        <span class="n">dotSigmaTNrr</span>  <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">dotSigmaTNesr</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">dotSigmaTNecr</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">dotSigmaTNpsr</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">dotSigmaTNpcr</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="n">dotSigmaTNes</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">dotSigmaTNec</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">dotSigmaTNps</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">dotSigmaTNpc</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="n">dotSigmaTNeces</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">dotSigmaTNpses</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">dotSigmaTNpces</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">dotSigmaTNpsec</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">dotSigmaTNpcec</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">dotSigmaTNpcps</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="n">dotTNes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n2</span><span class="p">)</span>
        <span class="n">dotTNec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n2</span><span class="p">)</span>
        <span class="n">dotTNps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n2</span><span class="p">)</span>
        <span class="n">dotTNpc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n2</span><span class="p">)</span>
        <span class="c1">#dotTNr  = np.zeros(n2)</span>

        <span class="k">for</span> <span class="n">itrj</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">n2</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">itrk</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">n1</span><span class="p">):</span>
                <span class="n">dotTNes</span><span class="p">[</span><span class="n">itrj</span><span class="p">]</span> <span class="o">+=</span> <span class="n">TNv</span><span class="p">[</span><span class="n">itrk</span><span class="p">,</span><span class="n">itrj</span><span class="p">]</span><span class="o">*</span><span class="n">ET_sin</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span>
                <span class="n">dotTNec</span><span class="p">[</span><span class="n">itrj</span><span class="p">]</span> <span class="o">+=</span> <span class="n">TNv</span><span class="p">[</span><span class="n">itrk</span><span class="p">,</span><span class="n">itrj</span><span class="p">]</span><span class="o">*</span><span class="n">ET_cos</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span>
                <span class="n">dotTNps</span><span class="p">[</span><span class="n">itrj</span><span class="p">]</span> <span class="o">+=</span> <span class="n">TNv</span><span class="p">[</span><span class="n">itrk</span><span class="p">,</span><span class="n">itrj</span><span class="p">]</span><span class="o">*</span><span class="n">PT_sin</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span>
                <span class="n">dotTNpc</span><span class="p">[</span><span class="n">itrj</span><span class="p">]</span> <span class="o">+=</span> <span class="n">TNv</span><span class="p">[</span><span class="n">itrk</span><span class="p">,</span><span class="n">itrj</span><span class="p">]</span><span class="o">*</span><span class="n">PT_cos</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span>
        <span class="c1">#        dotTNr[itrj]  += TNv[itrk,itrj]*Nr[itrk]</span>

        <span class="c1">#combine into a matrix to allow solve_triangular to work better</span>
        <span class="n">dotTN5</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="n">n2</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">dotTN5</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dotTNes</span>
        <span class="n">dotTN5</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dotTNec</span>
        <span class="n">dotTN5</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dotTNps</span>
        <span class="n">dotTN5</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">dotTNpc</span>
        <span class="c1">#dotTN5[:,4] = dotTNr</span>
        <span class="n">dotTN5</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">dotTNr</span>

        <span class="n">SigmaTN5Prod</span> <span class="o">=</span> <span class="n">solve_triangular</span><span class="p">(</span><span class="n">chol_Sigma</span><span class="p">,</span><span class="n">dotTN5</span><span class="p">,</span><span class="n">lower_a</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">trans_a</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">overwrite_b</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1">#SigmaTNesProd = solve_triangular(chol_Sigma,dotTNes,lower_a=True,trans_a=False,overwrite_b=True)</span>
        <span class="c1">#SigmaTNecProd = solve_triangular(chol_Sigma,dotTNec,lower_a=True,trans_a=False,overwrite_b=True)</span>
        <span class="c1">#SigmaTNpsProd = solve_triangular(chol_Sigma,dotTNps,lower_a=True,trans_a=False,overwrite_b=True)</span>
        <span class="c1">#SigmaTNpcProd = solve_triangular(chol_Sigma,dotTNpc,lower_a=True,trans_a=False,overwrite_b=True)</span>
        <span class="c1">#SigmaTNrProd  = solve_triangular(chol_Sigma,dotTNr ,lower_a=True,trans_a=False,overwrite_b=True)</span>

        <span class="k">for</span> <span class="n">itrj1</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">n2</span><span class="p">):</span>
            <span class="n">SigmaTNesProd</span> <span class="o">=</span> <span class="n">SigmaTN5Prod</span><span class="p">[</span><span class="n">itrj1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">SigmaTNecProd</span> <span class="o">=</span> <span class="n">SigmaTN5Prod</span><span class="p">[</span><span class="n">itrj1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">SigmaTNpsProd</span> <span class="o">=</span> <span class="n">SigmaTN5Prod</span><span class="p">[</span><span class="n">itrj1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">SigmaTNpcProd</span> <span class="o">=</span> <span class="n">SigmaTN5Prod</span><span class="p">[</span><span class="n">itrj1</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">SigmaTNrProd</span>  <span class="o">=</span> <span class="n">SigmaTN5Prod</span><span class="p">[</span><span class="n">itrj1</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>

            <span class="n">dotSigmaTNesr</span> <span class="o">+=</span> <span class="n">SigmaTNesProd</span><span class="o">*</span><span class="n">SigmaTNrProd</span>
            <span class="n">dotSigmaTNecr</span> <span class="o">+=</span> <span class="n">SigmaTNecProd</span><span class="o">*</span><span class="n">SigmaTNrProd</span>
            <span class="n">dotSigmaTNpsr</span> <span class="o">+=</span> <span class="n">SigmaTNpsProd</span><span class="o">*</span><span class="n">SigmaTNrProd</span>
            <span class="n">dotSigmaTNpcr</span> <span class="o">+=</span> <span class="n">SigmaTNpcProd</span><span class="o">*</span><span class="n">SigmaTNrProd</span>
            <span class="n">dotSigmaTNrr</span>  <span class="o">+=</span> <span class="n">SigmaTNrProd</span><span class="o">*</span><span class="n">SigmaTNrProd</span>

            <span class="n">dotSigmaTNes</span> <span class="o">+=</span> <span class="n">SigmaTNesProd</span><span class="o">*</span><span class="n">SigmaTNesProd</span>
            <span class="n">dotSigmaTNec</span> <span class="o">+=</span> <span class="n">SigmaTNecProd</span><span class="o">*</span><span class="n">SigmaTNecProd</span>
            <span class="n">dotSigmaTNps</span> <span class="o">+=</span> <span class="n">SigmaTNpsProd</span><span class="o">*</span><span class="n">SigmaTNpsProd</span>
            <span class="n">dotSigmaTNpc</span> <span class="o">+=</span> <span class="n">SigmaTNpcProd</span><span class="o">*</span><span class="n">SigmaTNpcProd</span>

            <span class="n">dotSigmaTNeces</span> <span class="o">+=</span> <span class="n">SigmaTNecProd</span><span class="o">*</span><span class="n">SigmaTNesProd</span>
            <span class="n">dotSigmaTNpses</span> <span class="o">+=</span> <span class="n">SigmaTNpsProd</span><span class="o">*</span><span class="n">SigmaTNesProd</span>
            <span class="n">dotSigmaTNpces</span> <span class="o">+=</span> <span class="n">SigmaTNpcProd</span><span class="o">*</span><span class="n">SigmaTNesProd</span>
            <span class="n">dotSigmaTNpsec</span> <span class="o">+=</span> <span class="n">SigmaTNpsProd</span><span class="o">*</span><span class="n">SigmaTNecProd</span>
            <span class="n">dotSigmaTNpcec</span> <span class="o">+=</span> <span class="n">SigmaTNpcProd</span><span class="o">*</span><span class="n">SigmaTNecProd</span>
            <span class="n">dotSigmaTNpcps</span> <span class="o">+=</span> <span class="n">SigmaTNpcProd</span><span class="o">*</span><span class="n">SigmaTNpsProd</span>

        <span class="c1">#get resres</span>
        <span class="n">resres_array</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">dotSigmaTNrr</span>

        <span class="c1">#get NN</span>
        <span class="n">NN</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">psNr</span> <span class="o">-</span> <span class="n">dotSigmaTNpsr</span>
        <span class="n">NN</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pcNr</span> <span class="o">-</span> <span class="n">dotSigmaTNpcr</span>

        <span class="c1">#get MM</span>
        <span class="c1">#diagonal</span>
        <span class="n">MM</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">psNps</span> <span class="o">-</span> <span class="n">dotSigmaTNps</span>
        <span class="n">MM</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pcNpc</span> <span class="o">-</span> <span class="n">dotSigmaTNpc</span>
        <span class="c1">#lower triangle</span>
        <span class="n">MM</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">psNes</span> <span class="o">-</span> <span class="n">dotSigmaTNpses</span>
        <span class="n">MM</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pcNes</span> <span class="o">-</span> <span class="n">dotSigmaTNpces</span>
        <span class="n">MM</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">psNec</span> <span class="o">-</span> <span class="n">dotSigmaTNpsec</span>
        <span class="n">MM</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pcNec</span> <span class="o">-</span> <span class="n">dotSigmaTNpcec</span>
        <span class="n">MM</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pcNps</span> <span class="o">-</span> <span class="n">dotSigmaTNpcps</span>
        <span class="c1">#upper triangle</span>
        <span class="n">MM</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">MM</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">MM</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">MM</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">MM</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">MM</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">MM</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">MM</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">MM</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">MM</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1">#if dist_only:</span>
        <span class="c1">#    MM[0:2,0:2] = MMs[ii,0:2,0:2]</span>
        <span class="c1">#else:</span>
        <span class="n">NN</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">esNr</span> <span class="o">-</span> <span class="n">dotSigmaTNesr</span>
        <span class="n">NN</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ecNr</span> <span class="o">-</span> <span class="n">dotSigmaTNecr</span>

        <span class="n">MM</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">esNes</span> <span class="o">-</span> <span class="n">dotSigmaTNes</span>
        <span class="n">MM</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ecNec</span> <span class="o">-</span> <span class="n">dotSigmaTNec</span>
        <span class="n">MM</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ecNes</span> <span class="o">-</span> <span class="n">dotSigmaTNeces</span>
        <span class="n">MM</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">MM</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">MMs</span><span class="p">[</span><span class="n">ii</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">MM</span></div>


<div class="viewcode-block" id="update_intrinsic_params"><a class="viewcode-back" href="../../QuickCW.html#QuickCW.CWFastLikelihoodNumba.update_intrinsic_params">[docs]</a><span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">update_intrinsic_params</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">isqrNvecs</span><span class="p">,</span><span class="n">Nrs</span><span class="p">,</span><span class="n">pos</span><span class="p">,</span><span class="n">pdist</span><span class="p">,</span><span class="n">toas</span><span class="p">,</span><span class="n">NN</span><span class="p">,</span><span class="n">MMs</span><span class="p">,</span><span class="n">SigmaTNrProds</span><span class="p">,</span><span class="n">invchol_Sigma_TNs</span><span class="p">,</span><span class="n">idxs</span><span class="p">,</span><span class="n">dist_only</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Calculate inner products N=(res|S), M=(S|S)</span>

<span class="sd">    :param x0:</span>
<span class="sd">    CWInfo object</span>
<span class="sd">    :param isqrNvecs:</span>
<span class="sd">    Inverse squareroot of N vectors</span>
<span class="sd">    :param Nrs:</span>
<span class="sd">    Residuals times inverse sqareroot N vectors</span>
<span class="sd">    :param pos:</span>
<span class="sd">    (number of pulsars, 3) array holding 3d unit vector pointing towards each pulsar given by psr.pos</span>
<span class="sd">    :param pdist:</span>
<span class="sd">    (number of pulsars, 2) array holding distance and error of distance for each pulsar in kpc given by psr.pdist</span>
<span class="sd">    :param toas:</span>
<span class="sd">    List of arrays of TOAs for each pulsar</span>
<span class="sd">    :param NN:</span>
<span class="sd">    N matrices holding (filter|residual) type inner products</span>
<span class="sd">    :param MMs:</span>
<span class="sd">    M matrices holding (filter|filter) type inner products</span>
<span class="sd">    :param SigmaTNrProds:</span>
<span class="sd">    ---</span>
<span class="sd">    :param invchol_Sigma_TNs:</span>
<span class="sd">    ---</span>
<span class="sd">    :param idxs:</span>
<span class="sd">    Indices of pulsar for which we want to update things</span>
<span class="sd">    :param dist_only:</span>
<span class="sd">    Option to skip parts of calculation whn only updating pulsar distances - not currently used</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">w0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mf">10.0</span><span class="o">**</span><span class="n">x0</span><span class="o">.</span><span class="n">log10_fgw</span>
    <span class="n">mc</span> <span class="o">=</span> <span class="mf">10.0</span><span class="o">**</span><span class="n">x0</span><span class="o">.</span><span class="n">log10_mc</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">Tsun</span>
    <span class="n">gwtheta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">x0</span><span class="o">.</span><span class="n">cos_gwtheta</span><span class="p">)</span>

    <span class="n">sin_gwtheta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gwtheta</span><span class="p">)</span>
    <span class="n">cos_gwtheta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gwtheta</span><span class="p">)</span>
    <span class="n">sin_gwphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x0</span><span class="o">.</span><span class="n">gwphi</span><span class="p">)</span>
    <span class="n">cos_gwphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x0</span><span class="o">.</span><span class="n">gwphi</span><span class="p">)</span>

    <span class="n">omhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">sin_gwtheta</span> <span class="o">*</span> <span class="n">cos_gwphi</span><span class="p">,</span> <span class="o">-</span><span class="n">sin_gwtheta</span> <span class="o">*</span> <span class="n">sin_gwphi</span><span class="p">,</span> <span class="o">-</span><span class="n">cos_gwtheta</span><span class="p">])</span>

    <span class="n">MM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
        <span class="n">cosMu</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">omhat</span><span class="p">,</span> <span class="n">pos</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>

        <span class="n">p_dist</span> <span class="o">=</span> <span class="p">(</span><span class="n">pdist</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">pdist</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">x0</span><span class="o">.</span><span class="n">cw_p_dists</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">kpc</span><span class="o">/</span><span class="n">const</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>

        <span class="n">omega_p013</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mf">1.</span> <span class="o">+</span> <span class="mf">256.</span><span class="o">/</span><span class="mf">5.</span> <span class="o">*</span> <span class="n">mc</span><span class="o">**</span><span class="p">(</span><span class="mi">5</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">w0</span><span class="o">**</span><span class="p">(</span><span class="mi">8</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">p_dist</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">cosMu</span><span class="p">)))))</span>

        <span class="c1">#get the solution to Lx=a for N, note this uses my own numba compatible lapack wrapper but is basically the same as scipy</span>
        <span class="n">invCholSigmaTN</span> <span class="o">=</span> <span class="n">invchol_Sigma_TNs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">SigmaTNrProd</span> <span class="o">=</span> <span class="n">SigmaTNrProds</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>

        <span class="c1">#divide the signals by N</span>
        <span class="n">Nr</span> <span class="o">=</span> <span class="n">Nrs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="c1">#residuals[ii]/Nvecs[ii]</span>
        <span class="n">isqrNvec</span> <span class="o">=</span> <span class="n">isqrNvecs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">toas_in</span> <span class="o">=</span> <span class="n">toas</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>

        <span class="n">esNr</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">ecNr</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">psNr</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">pcNr</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="n">esNes</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">ecNec</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">psNps</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">pcNpc</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="n">ecNes</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">psNes</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">pcNes</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">psNec</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">pcNec</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">pcNps</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="c1">#get the sin and cosine parts</span>
        <span class="n">ET_sin</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">invCholSigmaTN</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ET_cos</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">invCholSigmaTN</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">PT_sin</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">invCholSigmaTN</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">PT_cos</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">invCholSigmaTN</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1">#break out this loop instead of using numpy syntax so we don&#39;t have to store omegas and phases ever</span>
        <span class="k">for</span> <span class="n">itrk</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">invCholSigmaTN</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="c1">#set up filters</span>
            <span class="n">toas_loc</span> <span class="o">=</span> <span class="n">toas_in</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span> <span class="o">-</span> <span class="n">cm</span><span class="o">.</span><span class="n">tref</span>
            <span class="c1">#NOTE factored out the common w0 into factor of w0**(-5/3) in phase, cancels in ratios</span>
            <span class="c1">#also replace omega with 1/omega**(1/3), which is the quantity we actually need</span>
            <span class="c1">#if sqrt is a native cpu function 3 sqrts will probably be faster than taking the eigth root</span>
            <span class="n">omega13</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mf">1.</span> <span class="o">-</span> <span class="mf">256.</span><span class="o">/</span><span class="mf">5.</span> <span class="o">*</span> <span class="n">mc</span><span class="o">**</span><span class="p">(</span><span class="mf">5.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span> <span class="o">*</span> <span class="n">w0</span><span class="o">**</span><span class="p">(</span><span class="mf">8.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span> <span class="o">*</span> <span class="n">toas_loc</span><span class="p">))))</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">32</span><span class="o">/</span><span class="n">mc</span><span class="o">**</span><span class="p">(</span><span class="mi">5</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">w0</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">omega13</span><span class="o">**</span><span class="mi">5</span><span class="p">)</span>

            <span class="n">tp</span> <span class="o">=</span> <span class="n">toas_loc</span> <span class="o">-</span> <span class="n">p_dist</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">cosMu</span><span class="p">)</span>
            <span class="n">omega_p13</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mf">1.</span><span class="o">/</span><span class="n">omega_p013</span><span class="o">**</span><span class="mi">8</span> <span class="o">-</span> <span class="mf">256.</span><span class="o">/</span><span class="mf">5.</span> <span class="o">*</span> <span class="n">mc</span><span class="o">**</span><span class="p">(</span><span class="mi">5</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">w0</span><span class="o">**</span><span class="p">(</span><span class="mi">8</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="n">omega_p013</span><span class="o">**</span><span class="mi">8</span> <span class="o">*</span> <span class="n">tp</span><span class="p">))))</span>

            <span class="n">phase_p</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">32</span><span class="o">*</span><span class="n">mc</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">w0</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">omega_p013</span><span class="o">**</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">omega_p13</span><span class="o">**</span><span class="mi">5</span><span class="p">)</span>

            <span class="n">PT_amp</span> <span class="o">=</span> <span class="n">isqrNvec</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span> <span class="o">*</span> <span class="n">omega_p13</span>
            <span class="n">ET_amp</span> <span class="o">=</span> <span class="n">isqrNvec</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span> <span class="o">*</span> <span class="n">omega13</span>

            <span class="n">PT_sin</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span> <span class="o">=</span> <span class="n">PT_amp</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">phase_p</span><span class="p">)</span>
            <span class="n">PT_cos</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span> <span class="o">=</span> <span class="n">PT_amp</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">phase_p</span><span class="p">)</span>


            <span class="n">ET_sin</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span> <span class="o">=</span> <span class="n">ET_amp</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">phase</span><span class="p">)</span>
            <span class="n">ET_cos</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span> <span class="o">=</span> <span class="n">ET_amp</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">phase</span><span class="p">)</span>

            <span class="c1">#get the results</span>

            <span class="n">psNr</span> <span class="o">+=</span> <span class="n">Nr</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span><span class="o">*</span><span class="n">PT_sin</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span>
            <span class="n">pcNr</span> <span class="o">+=</span> <span class="n">Nr</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span><span class="o">*</span><span class="n">PT_cos</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span>

            <span class="n">psNps</span> <span class="o">+=</span> <span class="n">PT_sin</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span><span class="o">*</span><span class="n">PT_sin</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span>
            <span class="n">pcNpc</span> <span class="o">+=</span> <span class="n">PT_cos</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span><span class="o">*</span><span class="n">PT_cos</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span>

            <span class="n">psNes</span> <span class="o">+=</span> <span class="n">PT_sin</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span><span class="o">*</span><span class="n">ET_sin</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span>
            <span class="n">pcNes</span> <span class="o">+=</span> <span class="n">PT_cos</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span><span class="o">*</span><span class="n">ET_sin</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span>
            <span class="n">psNec</span> <span class="o">+=</span> <span class="n">PT_sin</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span><span class="o">*</span><span class="n">ET_cos</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span>
            <span class="n">pcNec</span> <span class="o">+=</span> <span class="n">PT_cos</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span><span class="o">*</span><span class="n">ET_cos</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span>
            <span class="n">pcNps</span> <span class="o">+=</span> <span class="n">PT_cos</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span><span class="o">*</span><span class="n">PT_sin</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span>

            <span class="c1">#these segments aren&#39;t the time limiting factor so we don&#39;t see any real speedup from skipping them</span>
            <span class="c1">#if not dist_only:</span>
            <span class="c1">#Nes = iNvec[itrk]*ET_sin[itrk]</span>
            <span class="c1">#Nec = iNvec[itrk]*ET_cos[itrk]</span>
            <span class="n">esNr</span> <span class="o">+=</span> <span class="n">Nr</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span><span class="o">*</span><span class="n">ET_sin</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span>
            <span class="n">ecNr</span> <span class="o">+=</span> <span class="n">Nr</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span><span class="o">*</span><span class="n">ET_cos</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span>
            <span class="n">esNes</span> <span class="o">+=</span> <span class="n">ET_sin</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span><span class="o">*</span><span class="n">ET_sin</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span>
            <span class="n">ecNec</span> <span class="o">+=</span> <span class="n">ET_cos</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span><span class="o">*</span><span class="n">ET_cos</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span>
            <span class="n">ecNes</span> <span class="o">+=</span> <span class="n">ET_cos</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span><span class="o">*</span><span class="n">ET_sin</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span>

        <span class="n">dotSigmaTNesr</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">dotSigmaTNecr</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">dotSigmaTNpsr</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">dotSigmaTNpcr</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="n">dotSigmaTNes</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">dotSigmaTNec</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">dotSigmaTNps</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">dotSigmaTNpc</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="n">dotSigmaTNeces</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">dotSigmaTNpses</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">dotSigmaTNpces</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">dotSigmaTNpsec</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">dotSigmaTNpcec</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">dotSigmaTNpcps</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="c1">#although we could do this in the upper loop without saving ET_sin/ET_cos arrays etc,</span>
        <span class="c1">#in my testing it was faster to do it in the transposed order as long as invCholSigmaTN is C contiguous</span>
        <span class="k">for</span> <span class="n">itrj</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">invCholSigmaTN</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">SigmaTNesProd</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">SigmaTNecProd</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">SigmaTNpsProd</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">SigmaTNpcProd</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="c1">#this loop is currently the limiting factor</span>
            <span class="k">for</span> <span class="n">itrk</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">invCholSigmaTN</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">SigmaTNpsProd</span> <span class="o">+=</span> <span class="n">invCholSigmaTN</span><span class="p">[</span><span class="n">itrj</span><span class="p">,</span><span class="n">itrk</span><span class="p">]</span><span class="o">*</span><span class="n">PT_sin</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span>
                <span class="n">SigmaTNpcProd</span> <span class="o">+=</span> <span class="n">invCholSigmaTN</span><span class="p">[</span><span class="n">itrj</span><span class="p">,</span><span class="n">itrk</span><span class="p">]</span><span class="o">*</span><span class="n">PT_cos</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span>
                <span class="n">SigmaTNesProd</span> <span class="o">+=</span> <span class="n">invCholSigmaTN</span><span class="p">[</span><span class="n">itrj</span><span class="p">,</span><span class="n">itrk</span><span class="p">]</span><span class="o">*</span><span class="n">ET_sin</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span>
                <span class="n">SigmaTNecProd</span> <span class="o">+=</span> <span class="n">invCholSigmaTN</span><span class="p">[</span><span class="n">itrj</span><span class="p">,</span><span class="n">itrk</span><span class="p">]</span><span class="o">*</span><span class="n">ET_cos</span><span class="p">[</span><span class="n">itrk</span><span class="p">]</span>

            <span class="n">dotSigmaTNpsr</span> <span class="o">+=</span> <span class="n">SigmaTNpsProd</span><span class="o">*</span><span class="n">SigmaTNrProd</span><span class="p">[</span><span class="n">itrj</span><span class="p">]</span>
            <span class="n">dotSigmaTNpcr</span> <span class="o">+=</span> <span class="n">SigmaTNpcProd</span><span class="o">*</span><span class="n">SigmaTNrProd</span><span class="p">[</span><span class="n">itrj</span><span class="p">]</span>

            <span class="n">dotSigmaTNps</span> <span class="o">+=</span> <span class="n">SigmaTNpsProd</span><span class="o">*</span><span class="n">SigmaTNpsProd</span>
            <span class="n">dotSigmaTNpc</span> <span class="o">+=</span> <span class="n">SigmaTNpcProd</span><span class="o">*</span><span class="n">SigmaTNpcProd</span>

            <span class="n">dotSigmaTNpses</span> <span class="o">+=</span> <span class="n">SigmaTNpsProd</span><span class="o">*</span><span class="n">SigmaTNesProd</span>
            <span class="n">dotSigmaTNpces</span> <span class="o">+=</span> <span class="n">SigmaTNpcProd</span><span class="o">*</span><span class="n">SigmaTNesProd</span>
            <span class="n">dotSigmaTNpsec</span> <span class="o">+=</span> <span class="n">SigmaTNpsProd</span><span class="o">*</span><span class="n">SigmaTNecProd</span>
            <span class="n">dotSigmaTNpcec</span> <span class="o">+=</span> <span class="n">SigmaTNpcProd</span><span class="o">*</span><span class="n">SigmaTNecProd</span>
            <span class="n">dotSigmaTNpcps</span> <span class="o">+=</span> <span class="n">SigmaTNpcProd</span><span class="o">*</span><span class="n">SigmaTNpsProd</span>

            <span class="c1">#if not dist_only:</span>
            <span class="n">dotSigmaTNesr</span> <span class="o">+=</span> <span class="n">SigmaTNesProd</span><span class="o">*</span><span class="n">SigmaTNrProd</span><span class="p">[</span><span class="n">itrj</span><span class="p">]</span>
            <span class="n">dotSigmaTNecr</span> <span class="o">+=</span> <span class="n">SigmaTNecProd</span><span class="o">*</span><span class="n">SigmaTNrProd</span><span class="p">[</span><span class="n">itrj</span><span class="p">]</span>
            <span class="n">dotSigmaTNes</span> <span class="o">+=</span> <span class="n">SigmaTNesProd</span><span class="o">*</span><span class="n">SigmaTNesProd</span>
            <span class="n">dotSigmaTNec</span> <span class="o">+=</span> <span class="n">SigmaTNecProd</span><span class="o">*</span><span class="n">SigmaTNecProd</span>
            <span class="n">dotSigmaTNeces</span> <span class="o">+=</span> <span class="n">SigmaTNecProd</span><span class="o">*</span><span class="n">SigmaTNesProd</span>

        <span class="c1">#get NN</span>
        <span class="n">NN</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">psNr</span> <span class="o">-</span> <span class="n">dotSigmaTNpsr</span>
        <span class="n">NN</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pcNr</span> <span class="o">-</span> <span class="n">dotSigmaTNpcr</span>

        <span class="c1">#get MM</span>
        <span class="c1">#diagonal</span>
        <span class="n">MM</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">psNps</span> <span class="o">-</span> <span class="n">dotSigmaTNps</span>
        <span class="n">MM</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pcNpc</span> <span class="o">-</span> <span class="n">dotSigmaTNpc</span>
        <span class="c1">#lower triangle</span>
        <span class="n">MM</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">psNes</span> <span class="o">-</span> <span class="n">dotSigmaTNpses</span>
        <span class="n">MM</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pcNes</span> <span class="o">-</span> <span class="n">dotSigmaTNpces</span>
        <span class="n">MM</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">psNec</span> <span class="o">-</span> <span class="n">dotSigmaTNpsec</span>
        <span class="n">MM</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pcNec</span> <span class="o">-</span> <span class="n">dotSigmaTNpcec</span>
        <span class="n">MM</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pcNps</span> <span class="o">-</span> <span class="n">dotSigmaTNpcps</span>
        <span class="c1">#upper triangle</span>
        <span class="n">MM</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">MM</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">MM</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">MM</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">MM</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">MM</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">MM</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">MM</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">MM</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">MM</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1">#if dist_only:</span>
        <span class="c1">#    MM[0:2,0:2] = MMs[ii,0:2,0:2]</span>
        <span class="c1">#else:</span>
        <span class="n">NN</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">esNr</span> <span class="o">-</span> <span class="n">dotSigmaTNesr</span>
        <span class="n">NN</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ecNr</span> <span class="o">-</span> <span class="n">dotSigmaTNecr</span>

        <span class="n">MM</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">esNes</span> <span class="o">-</span> <span class="n">dotSigmaTNes</span>
        <span class="n">MM</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ecNec</span> <span class="o">-</span> <span class="n">dotSigmaTNec</span>
        <span class="n">MM</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ecNes</span> <span class="o">-</span> <span class="n">dotSigmaTNeces</span>
        <span class="n">MM</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">MM</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">MMs</span><span class="p">[</span><span class="n">ii</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">MM</span></div>

<div class="viewcode-block" id="FastLikeInfo"><a class="viewcode-back" href="../../QuickCW.html#QuickCW.CWFastLikelihoodNumba.FastLikeInfo">[docs]</a><span class="nd">@jitclass</span><span class="p">([(</span><span class="s1">&#39;resres&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),(</span><span class="s1">&#39;logdet&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),(</span><span class="s1">&#39;resres_array&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:]),(</span><span class="s1">&#39;logdet_array&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:]),(</span><span class="s1">&#39;logdet_base&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),(</span><span class="s1">&#39;logdet_base_orig&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>\
           <span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:,::</span><span class="mi">1</span><span class="p">]),(</span><span class="s1">&#39;pdist&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:,::</span><span class="mi">1</span><span class="p">]),(</span><span class="s1">&#39;toas&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">ListType</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">float64</span><span class="p">[::</span><span class="mi">1</span><span class="p">])),(</span><span class="s1">&#39;Npsr&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">),(</span><span class="s1">&#39;max_toa&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>\
           <span class="p">(</span><span class="s1">&#39;phiinvs&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">ListType</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">float64</span><span class="p">[::</span><span class="mi">1</span><span class="p">])),(</span><span class="s1">&#39;dotTNrs&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">ListType</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">float64</span><span class="p">[::</span><span class="mi">1</span><span class="p">])),(</span><span class="s1">&#39;Nvecs&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">ListType</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">float64</span><span class="p">[::</span><span class="mi">1</span><span class="p">])),</span>\
           <span class="p">(</span><span class="s1">&#39;isqrNvecs&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">ListType</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">float64</span><span class="p">[::</span><span class="mi">1</span><span class="p">])),(</span><span class="s1">&#39;Nrs&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">ListType</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">float64</span><span class="p">[::</span><span class="mi">1</span><span class="p">])),</span>\
           <span class="p">(</span><span class="s1">&#39;TNvs&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">ListType</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">float64</span><span class="p">[::</span><span class="mi">1</span><span class="p">,:])),(</span><span class="s1">&#39;chol_Sigmas&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">ListType</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">float64</span><span class="p">[::</span><span class="mi">1</span><span class="p">,:])),</span>\
           <span class="p">(</span><span class="s1">&#39;MMs&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:,:,::</span><span class="mi">1</span><span class="p">]),(</span><span class="s1">&#39;NN&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:,::</span><span class="mi">1</span><span class="p">]),</span>\
           <span class="p">(</span><span class="s1">&#39;cos_gwtheta&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),(</span><span class="s1">&#39;gwphi&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),(</span><span class="s1">&#39;log10_fgw&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),(</span><span class="s1">&#39;log10_mc&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),(</span><span class="s1">&#39;cw_p_dists&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:]),</span>\
           <span class="p">(</span><span class="s1">&#39;gwb_gamma&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),(</span><span class="s1">&#39;gwb_log10_A&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),(</span><span class="s1">&#39;rn_gammas&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:]),(</span><span class="s1">&#39;rn_log10_As&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:]),</span>
           <span class="p">(</span><span class="s1">&#39;includeCW&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">boolean</span><span class="p">),(</span><span class="s1">&#39;prior_recovery&#39;</span><span class="p">,</span><span class="n">nb</span><span class="o">.</span><span class="n">boolean</span><span class="p">)])</span>
<span class="k">class</span> <span class="nc">FastLikeInfo</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;simple jitclass to store the various elements of fast likelihood calculation in a way that can be accessed quickly from a numba environment</span>

<span class="sd">    :param logdet_base:</span>
<span class="sd">    Contibution to logdet without CW signal</span>
<span class="sd">    :param pos:</span>
<span class="sd">    (number of pulsars, 3) array holding 3d unit vector pointing towards each pulsar given by psr.pos</span>
<span class="sd">    :param pdist:</span>
<span class="sd">    (number of pulsars, 2) array holding distance and error of distance for each pulsar in kpc given by psr.pdist</span>
<span class="sd">    :param toas:</span>
<span class="sd">    List of arrays of TOAs for each pulsar</span>
<span class="sd">    :param Nvecs:</span>
<span class="sd">    List of N vectors</span>
<span class="sd">    :param Nrs:</span>
<span class="sd">    Residuals times inverse sqareroot N vectors</span>
<span class="sd">    :param max_toa:</span>
<span class="sd">    Maximum TOA over all pulsars</span>
<span class="sd">    :param x0:</span>
<span class="sd">    CWInfo object</span>
<span class="sd">    :param Npsr:</span>
<span class="sd">    Number of pulsars</span>
<span class="sd">    :param isqrNvecs:</span>
<span class="sd">    Inverse squareroot of N vectors</span>
<span class="sd">    :param TNvs:</span>
<span class="sd">    T vectros times inverse squareroot N vectors</span>
<span class="sd">    :param dotTNrs:</span>
<span class="sd">    Precalculated dot product of Nrs and TNvs</span>
<span class="sd">    :param chol_Sigmas:</span>
<span class="sd">    List of Cholesky decompositions of Sigma matrices</span>
<span class="sd">    :param phiinvs:</span>
<span class="sd">    List of phiinv matrices</span>
<span class="sd">    :param includeCW:</span>
<span class="sd">    Switch if we want to include the contribution of the CW signal or not [True]</span>
<span class="sd">    :param prior_recovery:</span>
<span class="sd">    If True, we return constant likelihood to be used for prior recovery diagnostic test [False]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">logdet_base</span><span class="p">,</span><span class="n">pos</span><span class="p">,</span><span class="n">pdist</span><span class="p">,</span><span class="n">toas</span><span class="p">,</span><span class="n">Nvecs</span><span class="p">,</span><span class="n">Nrs</span><span class="p">,</span><span class="n">max_toa</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">Npsr</span><span class="p">,</span><span class="n">isqrNvecs</span><span class="p">,</span><span class="n">TNvs</span><span class="p">,</span><span class="n">dotTNrs</span><span class="p">,</span><span class="n">chol_Sigmas</span><span class="p">,</span><span class="n">phiinvs</span><span class="p">,</span><span class="n">includeCW</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">prior_recovery</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resres</span> <span class="o">=</span> <span class="mf">0.</span> <span class="c1">#compute internally</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logdet</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resres_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Npsr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logdet_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Npsr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logdet_base</span> <span class="o">=</span> <span class="n">logdet_base</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logdet_base_orig</span> <span class="o">=</span> <span class="n">logdet_base</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_resres_logdet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resres_array</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">logdet_array</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">logdet_base</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdist</span> <span class="o">=</span> <span class="n">pdist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toas</span> <span class="o">=</span> <span class="n">toas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Npsr</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">Npsr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_toa</span> <span class="o">=</span> <span class="n">max_toa</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">phiinvs</span> <span class="o">=</span> <span class="n">phiinvs</span>
        <span class="c1">#self.invchol_Sigma_Ts = invchol_Sigma_Ts</span>
        <span class="c1">#self.invchol_Sigma_TNs = invchol_Sigma_TNs#List([invchol_Sigma_Ts[i]/Nvecs[i] for i in range(self.Npsr)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dotTNrs</span> <span class="o">=</span> <span class="n">dotTNrs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nvecs</span> <span class="o">=</span> <span class="n">Nvecs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isqrNvecs</span> <span class="o">=</span> <span class="n">isqrNvecs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nrs</span> <span class="o">=</span> <span class="n">Nrs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TNvs</span> <span class="o">=</span> <span class="n">TNvs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chol_Sigmas</span> <span class="o">=</span> <span class="n">chol_Sigmas</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">MMs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Npsr</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Npsr</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">update_intrinsic_params</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">includeCW</span><span class="o">=</span><span class="n">includeCW</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prior_recovery</span><span class="o">=</span><span class="n">prior_recovery</span>

    <span class="k">def</span> <span class="nf">get_lnlikelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;wrapper to get the log likelihood&quot;&quot;&quot;</span>
        <span class="c1">#assert isclose(self.cos_gwtheta, x0.cos_gwtheta)</span>
        <span class="c1">#assert isclose(self.gwphi, x0.gwphi)</span>
        <span class="c1">#assert isclose(self.log10_fgw, x0.log10_fgw)</span>
        <span class="c1">#assert isclose(self.log10_mc, x0.log10_mc)</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cos_gwtheta</span><span class="o">==</span><span class="n">x0</span><span class="o">.</span><span class="n">cos_gwtheta</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">gwphi</span><span class="o">==</span><span class="n">x0</span><span class="o">.</span><span class="n">gwphi</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">log10_fgw</span><span class="o">==</span><span class="n">x0</span><span class="o">.</span><span class="n">log10_fgw</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">log10_mc</span><span class="o">==</span><span class="n">x0</span><span class="o">.</span><span class="n">log10_mc</span>

        <span class="k">return</span> <span class="n">get_lnlikelihood_helper</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">resres</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">logdet</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pdist</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NN</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">MMs</span><span class="p">,</span><span class="n">includeCW</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">includeCW</span><span class="p">,</span><span class="n">prior_recovery</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prior_recovery</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_pulsar_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">psr_idx</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;recalculate MM and NN only for the affected pulsar if we only change a single pulsar distance&quot;&quot;&quot;</span>
        <span class="c1">#this method is just a wrapper for the special case of only 1 pulsar but it won&#39;t force recompilation</span>
        <span class="c1">#assert self.cos_gwtheta == x0.cos_gwtheta</span>
        <span class="c1">#assert self.gwphi == x0.gwphi</span>
        <span class="c1">#assert self.log10_fgw == x0.log10_fgw</span>
        <span class="c1">#assert self.log10_mc == x0.log10_mc</span>
        <span class="c1">#self.rn_gammas = x0.rn_gammas.copy() #hot fix</span>
        <span class="c1">#self.rn_log10_As = x0.rn_log10_As.copy()</span>
        <span class="c1">#assert np.all(self.rn_gammas==x0.rn_gammas)</span>
        <span class="c1">#assert np.all(self.rn_log10_As==x0.rn_log10_As)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cos_gwtheta</span><span class="o">==</span><span class="n">x0</span><span class="o">.</span><span class="n">cos_gwtheta</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">gwphi</span><span class="o">==</span><span class="n">x0</span><span class="o">.</span><span class="n">gwphi</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">log10_fgw</span><span class="o">==</span><span class="n">x0</span><span class="o">.</span><span class="n">log10_fgw</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">log10_mc</span><span class="o">==</span><span class="n">x0</span><span class="o">.</span><span class="n">log10_mc</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">gwb_gamma</span><span class="o">==</span><span class="n">x0</span><span class="o">.</span><span class="n">gwb_gamma</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">gwb_log10_A</span><span class="o">==</span><span class="n">x0</span><span class="o">.</span><span class="n">gwb_log10_A</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rn_gammas</span><span class="o">==</span><span class="n">x0</span><span class="o">.</span><span class="n">rn_gammas</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rn_log10_As</span><span class="o">==</span><span class="n">x0</span><span class="o">.</span><span class="n">rn_log10_As</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cw_p_dists</span><span class="p">[:</span><span class="n">psr_idx</span><span class="p">]</span><span class="o">==</span><span class="n">x0</span><span class="o">.</span><span class="n">cw_p_dists</span><span class="p">[:</span><span class="n">psr_idx</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cw_p_dists</span><span class="p">[</span><span class="n">psr_idx</span><span class="p">:]</span><span class="o">==</span><span class="n">x0</span><span class="o">.</span><span class="n">cw_p_dists</span><span class="p">[</span><span class="n">psr_idx</span><span class="p">:])</span>
        <span class="n">resres_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resres_array</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">update_intrinsic_params2</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">isqrNvecs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Nrs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pdist</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">toas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NN</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">MMs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">TNvs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">chol_Sigmas</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">psr_idx</span><span class="p">]),</span><span class="bp">self</span><span class="o">.</span><span class="n">resres_array</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dotTNrs</span><span class="p">)</span>
        <span class="c1">#protect from incorrectly overwriting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cw_p_dists</span><span class="p">[</span><span class="n">psr_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">cw_p_dists</span><span class="p">[</span><span class="n">psr_idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resres_array</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">resres_old</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_resres_logdet</span><span class="p">(</span><span class="n">resres_old</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">logdet_array</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">logdet_base</span><span class="p">)</span>
        <span class="c1">#assert np.all(resres_old==self.resres_array)</span>
    
    <span class="k">def</span> <span class="nf">update_pulsar_distances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">psr_idxs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;recalculate MM and NN only for the affected pulsar if  change an arbitrary number of single pulsar distances&quot;&quot;&quot;</span>
        <span class="c1">#assert self.cos_gwtheta == x0.cos_gwtheta</span>
        <span class="c1">#assert self.gwphi == x0.gwphi</span>
        <span class="c1">#assert self.log10_fgw == x0.log10_fgw</span>
        <span class="c1">#assert self.log10_mc == x0.log10_mc</span>
        <span class="c1">#self.rn_gammas = x0.rn_gammas.copy() #hot fix</span>
        <span class="c1">#self.rn_log10_As = x0.rn_log10_As.copy()</span>
        <span class="c1">#assert np.all(self.rn_gammas==x0.rn_gammas)</span>
        <span class="c1">#assert np.all(self.rn_log10_As==x0.rn_log10_As)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior_recovery</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cos_gwtheta</span><span class="o">==</span><span class="n">x0</span><span class="o">.</span><span class="n">cos_gwtheta</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">gwphi</span><span class="o">==</span><span class="n">x0</span><span class="o">.</span><span class="n">gwphi</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">log10_fgw</span><span class="o">==</span><span class="n">x0</span><span class="o">.</span><span class="n">log10_fgw</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">log10_mc</span><span class="o">==</span><span class="n">x0</span><span class="o">.</span><span class="n">log10_mc</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">gwb_gamma</span><span class="o">==</span><span class="n">x0</span><span class="o">.</span><span class="n">gwb_gamma</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">gwb_log10_A</span><span class="o">==</span><span class="n">x0</span><span class="o">.</span><span class="n">gwb_log10_A</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rn_gammas</span><span class="o">==</span><span class="n">x0</span><span class="o">.</span><span class="n">rn_gammas</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rn_log10_As</span><span class="o">==</span><span class="n">x0</span><span class="o">.</span><span class="n">rn_log10_As</span><span class="p">)</span>
        <span class="c1">#leave dist_only in even though it is not currently respected in case it turns out to be faster later</span>
        <span class="c1">#resres_temp = self.resres_array.copy()</span>
        <span class="n">resres_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resres_array</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior_recovery</span><span class="p">:</span>
            <span class="n">update_intrinsic_params2</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">isqrNvecs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Nrs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pdist</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">toas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NN</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">MMs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">TNvs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">chol_Sigmas</span><span class="p">,</span><span class="n">psr_idxs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">resres_array</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dotTNrs</span><span class="p">)</span>
        <span class="c1">#protect from incorrectly overwriting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cw_p_dists</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">cw_p_dists</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior_recovery</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_resres_logdet</span><span class="p">(</span><span class="n">resres_old</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">logdet_array</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">logdet_base</span><span class="p">)</span>

        <span class="c1">#if not np.all(resres_temp==resres_old):</span>
        <span class="c1">#    print(resres_temp)</span>
        <span class="c1">#    print(resres_old)</span>
        <span class="c1">#    print(np.allclose(resres_temp,resres_old))</span>
        <span class="c1">#    print(resres_temp==resres_old)</span>
        <span class="c1">#    print(psr_idxs)</span>
        <span class="c1">#    print(resres_temp[psr_idxs])</span>
        <span class="c1">#    print(resres_old[psr_idxs])</span>
        <span class="c1">#    self.update_intrinsic_params(x0)</span>
        <span class="c1">#    print(self.resres_array[psr_idxs])</span>
        <span class="c1">#    assert np.all(resres_old==self.resres_array)</span>
        <span class="c1">#    assert np.all(resres_temp==self.resres_array)</span>
        <span class="c1">#assert np.all(resres_temp==self.resres_array)</span>


    <span class="c1">#def update_intrinsic_params(self,x0):</span>
    <span class="c1">#    &quot;&quot;&quot;Recalculate filters with updated intrinsic parameters - not quite the same as the setup, since a few things are already stored&quot;&quot;&quot;</span>
    <span class="c1">#    update_intrinsic_params(x0,self.isqrNvecs,self.Nrs,self.pos,self.pdist,self.toas, self.NN, self.MMs,self.SigmaTNrProds,self.invchol_Sigma_TNs,np.arange(x0.Npsr),dist_only=False)</span>
    <span class="c1">#    #track the intrinsic parameters this was set at so we can throw in error if they are inconsistent with an input x0</span>
    <span class="c1">#    self.cos_gwtheta = x0.cos_gwtheta</span>
    <span class="c1">#    self.gwphi = x0.gwphi</span>
    <span class="c1">#    self.log10_fgw = x0.log10_fgw</span>
    <span class="c1">#    self.log10_mc = x0.log10_mc</span>

    <span class="k">def</span> <span class="nf">update_intrinsic_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Recalculate filters with updated intrinsic parameters - not quite the same as the setup, since a few things are already stored&quot;&quot;&quot;</span>
        <span class="c1">#TODO ensure complete consistency with handling of resres</span>
        <span class="n">resres_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resres_array</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior_recovery</span><span class="p">:</span>
            <span class="n">update_intrinsic_params2</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">isqrNvecs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Nrs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pdist</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">toas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NN</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">MMs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">TNvs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">chol_Sigmas</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">x0</span><span class="o">.</span><span class="n">Npsr</span><span class="p">),</span><span class="n">resres_temp</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dotTNrs</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">set_resres_logdet</span><span class="p">(</span><span class="n">resres_temp</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">logdet_array</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">logdet_base</span><span class="p">)</span>
        <span class="c1">#track the intrinsic parameters this was set at so we can throw in error if they are inconsistent with an input x0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gwb_gamma</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">gwb_gamma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gwb_log10_A</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">gwb_log10_A</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rn_gammas</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">rn_gammas</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rn_log10_As</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">rn_log10_As</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cos_gwtheta</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">cos_gwtheta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gwphi</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">gwphi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log10_fgw</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">log10_fgw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log10_mc</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">log10_mc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cw_p_dists</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">cw_p_dists</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">update_red_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">psr_idxs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;recalculate MM and NN only for the affected pulsars of red noise update - almost same as update_pulsar_distances but with different asserts and param updates&quot;&quot;&quot;</span>
        <span class="n">resres_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resres_array</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior_recovery</span><span class="p">:</span>
            <span class="n">update_intrinsic_params2</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">isqrNvecs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Nrs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pdist</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">toas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NN</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">MMs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">TNvs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">chol_Sigmas</span><span class="p">,</span><span class="n">psr_idxs</span><span class="p">,</span><span class="n">resres_temp</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dotTNrs</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">set_resres_logdet</span><span class="p">(</span><span class="n">resres_temp</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">logdet_array</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">logdet_base</span><span class="p">)</span>
        <span class="c1">#track the intrinsic parameters this was set at so we can throw in error if they are inconsistent with an input x0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gwb_gamma</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">gwb_gamma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gwb_log10_A</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">gwb_log10_A</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rn_gammas</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">rn_gammas</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rn_log10_As</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">rn_log10_As</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cos_gwtheta</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">cos_gwtheta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gwphi</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">gwphi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log10_fgw</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">log10_fgw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log10_mc</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">log10_mc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cw_p_dists</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">cw_p_dists</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1">#assert self.cos_gwtheta==x0.cos_gwtheta</span>
        <span class="c1">#assert self.gwphi==x0.gwphi</span>
        <span class="c1">#assert self.log10_fgw==x0.log10_fgw</span>
        <span class="c1">#assert self.log10_mc==x0.log10_mc</span>
        <span class="c1">#assert self.gwb_gamma==x0.gwb_gamma</span>
        <span class="c1">#assert self.gwb_log10_A==x0.gwb_log10_A</span>
        <span class="c1">#assert np.all(self.cw_p_dists==x0.cw_p_dists)</span>
        <span class="c1">#</span>
        <span class="c1">#update_intrinsic_params2(x0,self.isqrNvecs,self.Nrs,self.pos,self.pdist,self.toas, self.NN, self.MMs,self.TNvs,self.chol_Sigmas,psr_idxs,self.resres_array,self.dotTNrs)</span>
        <span class="c1">#self.rn_gammas[:] = x0.rn_gammas.copy()</span>
        <span class="c1">#self.rn_log10_As[:] = x0.rn_log10_As.copy()</span>

    <span class="k">def</span> <span class="nf">validate_consistent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;validate parameters are consistent with input x0&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cos_gwtheta</span><span class="o">==</span><span class="n">x0</span><span class="o">.</span><span class="n">cos_gwtheta</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">gwphi</span><span class="o">==</span><span class="n">x0</span><span class="o">.</span><span class="n">gwphi</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">log10_fgw</span><span class="o">==</span><span class="n">x0</span><span class="o">.</span><span class="n">log10_fgw</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">log10_mc</span><span class="o">==</span><span class="n">x0</span><span class="o">.</span><span class="n">log10_mc</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">gwb_gamma</span><span class="o">==</span><span class="n">x0</span><span class="o">.</span><span class="n">gwb_gamma</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">gwb_log10_A</span><span class="o">==</span><span class="n">x0</span><span class="o">.</span><span class="n">gwb_log10_A</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rn_gammas</span><span class="o">==</span><span class="n">x0</span><span class="o">.</span><span class="n">rn_gammas</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rn_log10_As</span><span class="o">==</span><span class="n">x0</span><span class="o">.</span><span class="n">rn_log10_As</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cw_p_dists</span><span class="o">==</span><span class="n">x0</span><span class="o">.</span><span class="n">cw_p_dists</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">logdet_base_orig</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">logdet_base</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">logdet</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">logdet_base</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">logdet_array</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">resres</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">resres_array</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">set_resres_logdet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">resres_array</span><span class="p">,</span><span class="n">logdet_array</span><span class="p">,</span><span class="n">logdet_base</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;always reset resres and logdet with this method for maximum numerical consistency&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resres_array</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">resres_array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logdet_array</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">logdet_array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logdet_base</span> <span class="o">=</span> <span class="n">logdet_base</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resres</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">resres_array</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logdet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logdet_base</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logdet_array</span><span class="p">)</span></div>

<div class="viewcode-block" id="isclose"><a class="viewcode-back" href="../../QuickCW.html#QuickCW.CWFastLikelihoodNumba.isclose">[docs]</a><span class="nd">@njit</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">isclose</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">rtol</span><span class="o">=</span><span class="mf">1.e-5</span><span class="p">,</span><span class="n">atol</span><span class="o">=</span><span class="mf">1.e-8</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;check if close in same way as np.isclose</span>

<span class="sd">    :param a: First float to use in comparison</span>
<span class="sd">    :param b: Second float to use in comparison</span>
<span class="sd">    :param rtol: Realtive tolerance - default:1e-5</span>
<span class="sd">    :param atol: Absolute tolerance - default:1e-8</span>

<span class="sd">    :return: True/False indicating if a and b are close to each other</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">atol</span> <span class="o">+</span> <span class="n">rtol</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">b</span><span class="p">))</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Bence Becsy, Neil Cornish, Matthew Digman.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>