<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QuickCW.QuickCW &mdash; QuickCW  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            QuickCW
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">QuickCW</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">QuickCW.QuickCW</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for QuickCW.QuickCW</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;C 2021 Bence Becsy</span>
<span class="sd">MCMC for CW fast likelihood (w/ Neil Cornish and Matthew Digman)&quot;&quot;&quot;</span>
<span class="c1"># import pickle</span>

<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">perf_counter</span>
<span class="c1"># import glob</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="c1"># np.seterr(all=&#39;raise&#39;)</span>
<span class="c1"># make sure to use the right threading layer</span>
<span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">config</span>

<span class="n">config</span><span class="o">.</span><span class="n">THREADING_LAYER</span> <span class="o">=</span> <span class="s1">&#39;omp&#39;</span>
<span class="c1"># config.THREADING_LAYER = &#39;tbb&#39;</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of cores used for parallel running: &quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">NUMBA_NUM_THREADS</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">enterprise</span>
<span class="kn">from</span> <span class="nn">enterprise.pulsar</span> <span class="kn">import</span> <span class="n">Pulsar</span>
<span class="kn">import</span> <span class="nn">enterprise.signals.parameter</span> <span class="k">as</span> <span class="nn">parameter</span>
<span class="kn">from</span> <span class="nn">enterprise.signals</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">enterprise.signals</span> <span class="kn">import</span> <span class="n">signal_base</span>
<span class="kn">from</span> <span class="nn">enterprise.signals</span> <span class="kn">import</span> <span class="n">selections</span>
<span class="c1"># from enterprise.signals.selections import Selection</span>
<span class="kn">from</span> <span class="nn">enterprise.signals</span> <span class="kn">import</span> <span class="n">white_signals</span>
<span class="kn">from</span> <span class="nn">enterprise.signals</span> <span class="kn">import</span> <span class="n">gp_signals</span>
<span class="c1"># from enterprise.signals import deterministic_signals</span>

<span class="kn">from</span> <span class="nn">enterprise_extensions</span> <span class="kn">import</span> <span class="n">deterministic</span>

<span class="kn">import</span> <span class="nn">QuickCW.const_mcmc</span> <span class="k">as</span> <span class="nn">cm</span>
<span class="kn">from</span> <span class="nn">QuickCW.QuickMCMCUtils</span> <span class="kn">import</span> <span class="n">MCMCChain</span><span class="p">,</span> <span class="n">ChainParams</span>

<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">from</span> <span class="nn">QuickCW.PulsarDistPriors</span> <span class="kn">import</span> <span class="n">DMDistParameter</span><span class="p">,</span> <span class="n">PXDistParameter</span>

<span class="c1">################################################################################</span>
<span class="c1">#</span>
<span class="c1"># MAIN MCMC ENGINE</span>
<span class="c1">#</span>
<span class="c1">################################################################################</span>
<span class="c1">#@profile</span>
<div class="viewcode-block" id="QuickCW"><a class="viewcode-back" href="../../QuickCW.html#QuickCW.QuickCW.QuickCW">[docs]</a><span class="k">def</span> <span class="nf">QuickCW</span><span class="p">(</span><span class="n">chain_params</span><span class="p">,</span> <span class="n">psrs</span><span class="p">,</span> <span class="n">noise_json</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_legacy_equad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">include_ecorr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">amplitude_prior</span><span class="o">=</span><span class="s1">&#39;UL&#39;</span><span class="p">,</span> <span class="n">gwb_gamma_prior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">psr_distance_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">backend_selection</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set up all essential objects for QuickCW to do MCMC iterations</span>

<span class="sd">    :param chain_params:        ChainParams object</span>
<span class="sd">    :param psrs:                enterprise pulsar objects</span>
<span class="sd">    :param noise_json:          JSON file with noise dictionary [None]</span>
<span class="sd">    :param use_legacy_equad:    Option to use old convention for equad [False]</span>
<span class="sd">    :param include_ecorr:       Option to include ECORR white noise [True]</span>
<span class="sd">    :param amplitude_prior:     Prior to use on CW amplitude; &#39;UL&#39; indicates uniform in amplitude prior (used for upper limits); &#39;detection&#39; indicates uniform in log amplitude prior (used for Bayes factor calculation/detection)</span>
<span class="sd">    :param gwb_gamma_prior:     Option to specify prior range on GWB spectral index gamma; None means we use the default np.array([0,7]) [None]</span>
<span class="sd">    :param psr_distance_file:   File containing parallax and DM distance information for pulsars; If None, we use Gaussian prior with pulsar distance and error from psr objects [None]</span>
<span class="sd">    :param backend_selection:   Option to use an enterprise Selection based on backend; Usually use True for real data False for simulated data [True]</span>

<span class="sd">    :return pta:                enterprise PTA object</span>
<span class="sd">    :return mcc:                MCMCChain onject</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Began Main Loop&quot;</span><span class="p">)</span>

    <span class="n">ti</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>

    <span class="c1"># Get observing timespan</span>
    <span class="n">tmin</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">toas</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">psrs</span><span class="p">]</span>
    <span class="n">tmax</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">toas</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">psrs</span><span class="p">]</span>
    <span class="n">Tspan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tmax</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tmin</span><span class="p">)</span>

    <span class="n">efac</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="n">Constant</span><span class="p">()</span>
    <span class="n">equad</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="n">Constant</span><span class="p">()</span>
    <span class="n">ecorr</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="n">Constant</span><span class="p">()</span>

    <span class="c1"># define selection by observing backend</span>
    <span class="k">if</span> <span class="n">backend_selection</span><span class="p">:</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="n">selections</span><span class="o">.</span><span class="n">Selection</span><span class="p">(</span><span class="n">selections</span><span class="o">.</span><span class="n">by_backend</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="n">selections</span><span class="o">.</span><span class="n">Selection</span><span class="p">(</span><span class="n">selections</span><span class="o">.</span><span class="n">no_selection</span><span class="p">)</span>

    <span class="c1"># define white noise signals</span>
    <span class="k">if</span> <span class="n">use_legacy_equad</span><span class="p">:</span>
        <span class="n">ef</span> <span class="o">=</span> <span class="n">white_signals</span><span class="o">.</span><span class="n">MeasurementNoise</span><span class="p">(</span><span class="n">efac</span><span class="o">=</span><span class="n">efac</span><span class="p">,</span> <span class="n">selection</span><span class="o">=</span><span class="n">selection</span><span class="p">)</span>
        <span class="n">eq</span> <span class="o">=</span> <span class="n">white_signals</span><span class="o">.</span><span class="n">TNEquadNoise</span><span class="p">(</span><span class="n">log10_tnequad</span><span class="o">=</span><span class="n">equad</span><span class="p">,</span> <span class="n">selection</span><span class="o">=</span><span class="n">selection</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">efq</span> <span class="o">=</span> <span class="n">white_signals</span><span class="o">.</span><span class="n">MeasurementNoise</span><span class="p">(</span><span class="n">efac</span><span class="o">=</span><span class="n">efac</span><span class="p">,</span> <span class="n">log10_t2equad</span><span class="o">=</span><span class="n">equad</span><span class="p">,</span> <span class="n">selection</span><span class="o">=</span><span class="n">selection</span><span class="p">)</span>
    <span class="c1"># ec = white_signals.EcorrKernelNoise(log10_ecorr=ecorr, selection=selection)</span>
    <span class="c1"># ec = gp_signals.EcorrBasisModel(log10_ecorr=ecorr, selection=selection)</span>
    <span class="k">if</span> <span class="n">include_ecorr</span><span class="p">:</span>
        <span class="c1"># give ecorr a name so that we can use the usual noisefiles created for Kernel ecorr</span>
        <span class="n">ec</span> <span class="o">=</span> <span class="n">gp_signals</span><span class="o">.</span><span class="n">EcorrBasisModel</span><span class="p">(</span><span class="n">log10_ecorr</span><span class="o">=</span><span class="n">ecorr</span><span class="p">,</span> <span class="n">selection</span><span class="o">=</span><span class="n">selection</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="n">log10_A</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="o">-</span><span class="mi">11</span><span class="p">)</span>
    <span class="c1"># log10_A = parameter.Uniform(-18, -11)</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>

    <span class="c1"># define powerlaw PSD and red noise signal</span>
    <span class="n">pl</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">powerlaw</span><span class="p">(</span><span class="n">log10_A</span><span class="o">=</span><span class="n">log10_A</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">)</span>
    <span class="n">rn</span> <span class="o">=</span> <span class="n">gp_signals</span><span class="o">.</span><span class="n">FourierBasisGP</span><span class="p">(</span><span class="n">pl</span><span class="p">,</span> <span class="n">components</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

    <span class="n">log10_Agw</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span><span class="o">-</span><span class="mi">11</span><span class="p">)(</span><span class="s1">&#39;gwb_log10_A&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">gwb_gamma_prior</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gwb_gamma_prior</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">7</span><span class="p">])</span>

    <span class="n">gamma_gw</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="n">gwb_gamma_prior</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">gwb_gamma_prior</span><span class="p">[</span><span class="mi">1</span><span class="p">])(</span><span class="s1">&#39;gwb_gamma&#39;</span><span class="p">)</span>
    <span class="n">cpl</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">powerlaw</span><span class="p">(</span><span class="n">log10_A</span><span class="o">=</span><span class="n">log10_Agw</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">gamma_gw</span><span class="p">)</span>
    <span class="n">crn</span> <span class="o">=</span> <span class="n">gp_signals</span><span class="o">.</span><span class="n">FourierBasisGP</span><span class="p">(</span><span class="n">cpl</span><span class="p">,</span> <span class="n">components</span><span class="o">=</span><span class="n">chain_params</span><span class="o">.</span><span class="n">gwb_comps</span><span class="p">,</span> <span class="n">Tspan</span><span class="o">=</span><span class="n">Tspan</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;gw&#39;</span><span class="p">)</span>

    <span class="n">tm</span> <span class="o">=</span> <span class="n">gp_signals</span><span class="o">.</span><span class="n">TimingModel</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">include_ecorr</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">use_legacy_equad</span><span class="p">:</span>
            <span class="n">s_base</span> <span class="o">=</span> <span class="n">ef</span> <span class="o">+</span> <span class="n">eq</span> <span class="o">+</span> <span class="n">ec</span> <span class="o">+</span> <span class="n">rn</span> <span class="o">+</span> <span class="n">crn</span> <span class="o">+</span> <span class="n">tm</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s_base</span> <span class="o">=</span> <span class="n">efq</span>     <span class="o">+</span> <span class="n">ec</span> <span class="o">+</span> <span class="n">rn</span> <span class="o">+</span> <span class="n">crn</span> <span class="o">+</span> <span class="n">tm</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">use_legacy_equad</span><span class="p">:</span>
            <span class="n">s_base</span> <span class="o">=</span> <span class="n">ef</span> <span class="o">+</span> <span class="n">eq</span>      <span class="o">+</span> <span class="n">rn</span> <span class="o">+</span> <span class="n">crn</span> <span class="o">+</span> <span class="n">tm</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s_base</span> <span class="o">=</span> <span class="n">efq</span>          <span class="o">+</span> <span class="n">rn</span> <span class="o">+</span> <span class="n">crn</span> <span class="o">+</span> <span class="n">tm</span>


    <span class="c1">#cos_gwtheta = parameter.Uniform(-1,1)(&#39;0_cos_gwtheta&#39;)</span>
    <span class="c1">#gwphi = parameter.Uniform(0,2*np.pi)(&#39;0_gwphi&#39;)</span>
    <span class="n">cos_gwtheta</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="n">chain_params</span><span class="o">.</span><span class="n">cos_gwtheta_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">chain_params</span><span class="o">.</span><span class="n">cos_gwtheta_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])(</span><span class="s1">&#39;0_cos_gwtheta&#39;</span><span class="p">)</span>
    <span class="n">gwphi</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="n">chain_params</span><span class="o">.</span><span class="n">gwphi_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">chain_params</span><span class="o">.</span><span class="n">gwphi_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])(</span><span class="s1">&#39;0_gwphi&#39;</span><span class="p">)</span>

    <span class="c1"># set lower frequency bound to 1/Tspan if it&#39;s nan</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">chain_params</span><span class="o">.</span><span class="n">freq_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found lower frequency bound of nan - Setting it to 1/T.&#39;</span><span class="p">)</span>
        <span class="n">chain_params</span><span class="o">.</span><span class="n">freq_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">Tspan</span>
    <span class="n">log10_fgw</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">chain_params</span><span class="o">.</span><span class="n">freq_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">chain_params</span><span class="o">.</span><span class="n">freq_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]))(</span>
        <span class="s1">&#39;0_log10_fgw&#39;</span><span class="p">)</span>

    <span class="n">m_max</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="n">log10_mc</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">m_max</span><span class="p">)(</span><span class="s1">&#39;0_log10_mc&#39;</span><span class="p">)</span>

    <span class="n">phase0</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)(</span><span class="s1">&#39;0_phase0&#39;</span><span class="p">)</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)(</span><span class="s1">&#39;0_psi&#39;</span><span class="p">)</span>
    <span class="n">cos_inc</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)(</span><span class="s1">&#39;0_cos_inc&#39;</span><span class="p">)</span>

    <span class="n">p_phase</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">amplitude_prior</span> <span class="o">==</span> <span class="s1">&#39;detection&#39;</span><span class="p">:</span>
        <span class="n">log10_h</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">18</span><span class="p">,</span> <span class="o">-</span><span class="mi">11</span><span class="p">)(</span><span class="s1">&#39;0_log10_h&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">amplitude_prior</span> <span class="o">==</span> <span class="s1">&#39;UL&#39;</span><span class="p">:</span>
        <span class="n">log10_h</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="n">LinearExp</span><span class="p">(</span><span class="o">-</span><span class="mi">18</span><span class="p">,</span> <span class="o">-</span><span class="mi">11</span><span class="p">)(</span><span class="s1">&#39;0_log10_h&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;amplitude_prior provided not implemented</span><span class="se">\n</span><span class="s2">use either &#39;detection&#39; for uniform in log-amplitude or &#39;UL&#39; for uniform in amplitude prior&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">psr_distance_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1">#No pulsar distance file --&gt; use Gaussian prior with pulsar distance and error from psr objects</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">psr</span><span class="o">.</span><span class="n">pdist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">psr</span> <span class="ow">in</span> <span class="n">psrs</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span> <span class="c1">#raise error if this is used with psr objects having zero distance</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;It looks like some of the pulsar distances used are zero. Please provide psr_distance_file or use psr objects with nonzero distance.&quot;</span><span class="p">)</span>

        <span class="n">p_dist</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">cw_wf</span> <span class="o">=</span> <span class="n">deterministic</span><span class="o">.</span><span class="n">cw_delay</span><span class="p">(</span><span class="n">cos_gwtheta</span><span class="o">=</span><span class="n">cos_gwtheta</span><span class="p">,</span> <span class="n">gwphi</span><span class="o">=</span><span class="n">gwphi</span><span class="p">,</span> <span class="n">log10_mc</span><span class="o">=</span><span class="n">log10_mc</span><span class="p">,</span>
                                       <span class="n">log10_h</span><span class="o">=</span><span class="n">log10_h</span><span class="p">,</span> <span class="n">log10_fgw</span><span class="o">=</span><span class="n">log10_fgw</span><span class="p">,</span> <span class="n">phase0</span><span class="o">=</span><span class="n">phase0</span><span class="p">,</span> <span class="n">psrTerm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">p_phase</span><span class="o">=</span><span class="n">p_phase</span><span class="p">,</span> <span class="n">p_dist</span><span class="o">=</span><span class="n">p_dist</span><span class="p">,</span> <span class="n">evolve</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">psi</span><span class="o">=</span><span class="n">psi</span><span class="p">,</span> <span class="n">cos_inc</span><span class="o">=</span><span class="n">cos_inc</span><span class="p">,</span> <span class="n">tref</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">tref</span><span class="p">)</span>
        <span class="n">cw</span> <span class="o">=</span> <span class="n">deterministic</span><span class="o">.</span><span class="n">CWSignal</span><span class="p">(</span><span class="n">cw_wf</span><span class="p">,</span> <span class="n">psrTerm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;cw0&#39;</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">s_base</span> <span class="o">+</span> <span class="n">cw</span>

        <span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">(</span><span class="n">psr</span><span class="p">)</span> <span class="k">for</span> <span class="n">psr</span> <span class="ow">in</span> <span class="n">psrs</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1">#provided pulsar distance file --&gt; use information in that file for setting up pulsar distance priors</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">psr</span><span class="o">.</span><span class="n">pdist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">psr</span> <span class="ow">in</span> <span class="n">psrs</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">))</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">psr</span><span class="o">.</span><span class="n">pdist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">psr</span> <span class="ow">in</span> <span class="n">psrs</span><span class="p">])</span><span class="o">!=</span><span class="mi">1</span><span class="p">):</span> <span class="c1">#raise error if this is used while any of the pulsars have non-zero distance</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You are running in a mode using parallax and DM based pulsar distance priors, but some of the pulsar object have non-zero distances or non-unit variances. This method requires the pulsar objects to have zero mean and unit variance. Use psr objects that satisfy that or switch to using Gaussian priors based on distances in psr objects by setting psr_distance_file=None.&quot;</span><span class="p">)</span>

        <span class="c1">#load provided pulsar distance file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">psr_distance_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">pulsar_distances</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>

        <span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">psr</span> <span class="ow">in</span> <span class="n">psrs</span><span class="p">:</span>
            <span class="c1"># arguments for deterministic.cw_delay</span>
            <span class="n">cw_delay_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cos_gwtheta</span><span class="o">=</span><span class="n">cos_gwtheta</span><span class="p">,</span> <span class="n">gwphi</span><span class="o">=</span><span class="n">gwphi</span><span class="p">,</span> <span class="n">log10_mc</span><span class="o">=</span><span class="n">log10_mc</span><span class="p">,</span>
                                           <span class="n">log10_h</span><span class="o">=</span><span class="n">log10_h</span><span class="p">,</span> <span class="n">log10_fgw</span><span class="o">=</span><span class="n">log10_fgw</span><span class="p">,</span> <span class="n">phase0</span><span class="o">=</span><span class="n">phase0</span><span class="p">,</span> <span class="n">psrTerm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                           <span class="n">p_phase</span><span class="o">=</span><span class="n">p_phase</span><span class="p">,</span> <span class="n">evolve</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                           <span class="n">psi</span><span class="o">=</span><span class="n">psi</span><span class="p">,</span> <span class="n">cos_inc</span><span class="o">=</span><span class="n">cos_inc</span><span class="p">,</span> <span class="n">tref</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">tref</span><span class="p">)</span>
            <span class="c1"># arguments for deterministic.CWSignal</span>
            <span class="n">CWSignal_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">psrTerm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;cw0&#39;</span><span class="p">)</span>
            <span class="c1"># create CW signal applying pulsar distance prior</span>
            <span class="n">cw</span> <span class="o">=</span> <span class="n">per_pulsar_prior</span><span class="p">(</span><span class="n">psr</span><span class="p">,</span> <span class="n">pulsar_distances</span><span class="p">,</span> <span class="n">cw_delay_args</span><span class="p">,</span> <span class="n">CWSignal_args</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s_base</span> <span class="o">+</span> <span class="n">cw</span>

            <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">(</span><span class="n">psr</span><span class="p">))</span>

    <span class="n">t1</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Begin Loading Pulsar Timing Array from Enterprise at </span><span class="si">%8.3f</span><span class="s2">s&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t1</span> <span class="o">-</span> <span class="n">ti</span><span class="p">))</span>
    <span class="n">pta</span> <span class="o">=</span> <span class="n">signal_base</span><span class="o">.</span><span class="n">PTA</span><span class="p">(</span><span class="n">models</span><span class="p">)</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finished Loading Pulsar Timing Array from Enterprise at </span><span class="si">%8.3f</span><span class="s2">s&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t1</span> <span class="o">-</span> <span class="n">ti</span><span class="p">))</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">noise_json</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="n">noisedict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>

    <span class="c1"># print(noisedict)</span>
    <span class="n">pta</span><span class="o">.</span><span class="n">set_default_params</span><span class="p">(</span><span class="n">noisedict</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">chain_params</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">pta</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">chain_params</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;List of parameters in the model with their priors:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">pta</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

    <span class="c1"># get max toa which is needed to mae sure the initial parameters don&#39;t result in an already merged system</span>
    <span class="n">max_toa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">psrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">toas</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">psrs</span><span class="p">)):</span>
        <span class="n">max_toa</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_toa</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">psrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">toas</span><span class="p">))</span>

    <span class="c1">##############################################################################</span>
    <span class="c1">#</span>
    <span class="c1"># Make MCMC Object</span>
    <span class="c1">#</span>
    <span class="c1">##############################################################################</span>
    <span class="n">mcc</span> <span class="o">=</span> <span class="n">MCMCChain</span><span class="p">(</span><span class="n">chain_params</span><span class="p">,</span> <span class="n">psrs</span><span class="p">,</span> <span class="n">pta</span><span class="p">,</span> <span class="n">max_toa</span><span class="p">,</span> <span class="n">noisedict</span><span class="p">,</span> <span class="n">ti</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pta</span><span class="p">,</span> <span class="n">mcc</span></div>


<div class="viewcode-block" id="get_default_args"><a class="viewcode-back" href="../../QuickCW.html#QuickCW.QuickCW.get_default_args">[docs]</a><span class="k">def</span> <span class="nf">get_default_args</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gets default arguments from a python function&quot;&quot;&quot;</span>
    <span class="n">signature</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">default</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">signature</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span>
    <span class="p">}</span></div>


<div class="viewcode-block" id="per_pulsar_prior"><a class="viewcode-back" href="../../QuickCW.html#QuickCW.QuickCW.per_pulsar_prior">[docs]</a><span class="k">def</span> <span class="nf">per_pulsar_prior</span><span class="p">(</span><span class="n">enterprise_pulsar</span><span class="p">:</span> <span class="n">Pulsar</span><span class="p">,</span> <span class="n">pulsar_distances</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                     <span class="n">cw_delay_args</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">CWSignal_args</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a CW signal applying distance priors to individual pulsars based on DM or PX in the pulsar_distances dict</span>
<span class="sd">    </span>
<span class="sd">    :param enterprise_pulsar:</span>
<span class="sd">    enterprise pulsar object</span>
<span class="sd">    :param pulsar_distances:</span>
<span class="sd">    dictionary containing pulsar distance info</span>
<span class="sd">    :param cw_delay_args:</span>
<span class="sd">    arguments to be passed on to deterministic.cw_delay</span>
<span class="sd">    :param CWSignal_args:</span>
<span class="sd">    arguments to be passed on to deterministic.CWSignal</span>

<span class="sd">    :return cw:</span>
<span class="sd">    enterprise signal object with the CW model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cw_delay_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># could maybe replace this by using an empty dictionary instead</span>
        <span class="n">cw_delay_args</span> <span class="o">=</span> <span class="n">get_default_args</span><span class="p">(</span><span class="n">deterministic</span><span class="o">.</span><span class="n">cw_delay</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">CWSignal_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">CWSignal_args</span> <span class="o">=</span> <span class="n">get_default_args</span><span class="p">(</span><span class="n">deterministic</span><span class="o">.</span><span class="n">CWSignal</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;DM&#39;</span> <span class="ow">in</span> <span class="n">pulsar_distances</span><span class="p">[</span><span class="n">enterprise_pulsar</span><span class="o">.</span><span class="n">name</span><span class="p">]:</span>  <span class="c1"># use DM distance prior for this pulsar</span>
        <span class="n">p_dist</span> <span class="o">=</span> <span class="n">DMDistParameter</span><span class="p">(</span><span class="n">pulsar_distances</span><span class="p">[</span><span class="n">enterprise_pulsar</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                 <span class="n">pulsar_distances</span><span class="p">[</span><span class="n">enterprise_pulsar</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">elif</span> <span class="s1">&#39;PX&#39;</span> <span class="ow">in</span> <span class="n">pulsar_distances</span><span class="p">[</span><span class="n">enterprise_pulsar</span><span class="o">.</span><span class="n">name</span><span class="p">]:</span>  <span class="c1"># use parallax distance prior for this pulsar</span>
        <span class="n">p_dist</span> <span class="o">=</span> <span class="n">PXDistParameter</span><span class="p">(</span><span class="n">pulsar_distances</span><span class="p">[</span><span class="n">enterprise_pulsar</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                 <span class="n">pulsar_distances</span><span class="p">[</span><span class="n">enterprise_pulsar</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">cw_wf</span> <span class="o">=</span> <span class="n">deterministic</span><span class="o">.</span><span class="n">cw_delay</span><span class="p">(</span><span class="n">p_dist</span><span class="o">=</span><span class="n">p_dist</span><span class="p">,</span> <span class="o">**</span><span class="n">cw_delay_args</span><span class="p">)</span>

    <span class="n">cw</span> <span class="o">=</span> <span class="n">deterministic</span><span class="o">.</span><span class="n">CWSignal</span><span class="p">(</span><span class="n">cw_wf</span><span class="p">,</span> <span class="o">**</span><span class="n">CWSignal_args</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cw</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Bence Becsy, Neil Cornish, Matthew Digman.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>